<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport Détaillé - Planificateur d'Interventions</title>
    <link rel="icon" href="AD.jpeg" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Styles de base pour la page de rapport */
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .glow-text {
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .ad-header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .ad-header h1 {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .main-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        
        .table th {
            background-color: #2c3e50;
            color: white;
            border-bottom: 2px solid #3498db;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
            transform: scale(1.005);
            transition: all 0.2s ease;
        }
        
        .alert-custom {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .theme-selector {
            display: flex;
            gap: 5px;
            margin-left: 20px;
        }
        
        .theme-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            transition: transform 0.2s;
        }
        
        .theme-btn:hover {
            transform: scale(1.1);
        }
        
        .theme-light-btn { background-color: #ffffff; }
        .theme-dark-btn { background-color: #2c3e50; }
        .theme-neon-btn { background-color: #00ff00; }
        .theme-galaxy-btn { background-color: #1a1a2e; }
        .theme-rainbow-btn { 
            background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);
        }
        .theme-high-contrast-btn { 
            background-color: #000000; 
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .theme-pastel-btn { 
            background-color: #ffb6c1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body class="theme-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid d-flex align-items-center">
            <a class="navbar-brand" href="index.html">
                <img src="AD.jpeg" alt="Logo AD" class="img-fluid" style="width: 80px; height: 80px; object-fit: contain; border-radius: 8px; margin-right: 15px;">
                <span class="glow-text">Rapport Détaillé</span>
            </a>

            <div class="theme-selector">
                <div class="theme-btn theme-light-btn" title="Clair" onclick="changeTheme('light')"></div>
                <div class="theme-btn theme-dark-btn" title="Sombre" onclick="changeTheme('dark')"></div>
                <div class="theme-btn theme-neon-btn" title="Néon" onclick="changeTheme('neon')"></div>
                <div class="theme-btn theme-galaxy-btn" title="Galaxie" onclick="changeTheme('galaxy')"></div>
                <div class="theme-btn theme-rainbow-btn" title="Arc-en-ciel" onclick="changeTheme('rainbow')"></div>
                <div class="theme-btn theme-high-contrast-btn" title="Contraste élevé" onclick="changeTheme('high-contrast')">HC</div>
                <div class="theme-btn theme-pastel-btn" title="Pastel" onclick="changeTheme('pastel')">P</div>
            </div>

            <div class="navbar-text me-3">
                <span class="badge bg-warning text-dark">Église BERACA</span>
            </div>

            <div class="ms-3">
                <button class="btn btn-outline-info" id="help-btn" title="Aide">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>

            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown">
                    <i class="fas fa-globe me-1"></i>FR
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('fr')">Français</a></li>
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')">English</a></li>
                </ul>
            </div>

            <div class="ms-3">
                <button class="btn btn-outline-primary" id="refresh-btn" title="Actualiser les données">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
            </div>

            <div class="ms-3">
                <button class="btn btn-outline-primary" id="publish-btn" title="Publier les données">
                    <i class="fas fa-share-alt"></i> Publier
                </button>
            </div>

        </div>
    </nav>

    <div class="container mt-4">
        <!-- En-tête -->
        <div class="ad-header mb-4">
            <h1><i class="fas fa-chart-bar me-2"></i>RAPPORT DÉTAILLÉ DES INTERVENTIONS</h1>
            <p>Suivi et analyse des interventions planifiées</p>
        </div>

        <!-- Filtres avancés -->
        <div class="card main-card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-filter me-2"></i>Filtres de Recherche</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="filter-date-start" class="form-label">Date de début</label>
                        <input type="date" class="form-control" id="filter-date-start">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filter-date-end" class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="filter-date-end">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filter-cult-type" class="form-label">Type de culte</label>
                        <select class="form-select" id="filter-cult-type">
                            <option value="">Tous les types</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filter-place" class="form-label">Lieu</label>
                        <select class="form-select" id="filter-place">
                            <option value="">Tous les lieux</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="filter-intervenant" class="form-label">Intervenant</label>
                        <select class="form-select" id="filter-intervenant">
                            <option value="">Tous les intervenants</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-category" class="form-label">Catégorie</label>
                        <select class="form-select" id="filter-category">
                            <option value="">Toutes les catégories</option>
                            <option value="clergy">Clergé</option>
                            <option value="members">Membres</option>
                            <option value="singers">Chanteurs</option>
                            <option value="musicians">Musiciens</option>
                            <option value="technical">Technique</option>
                            <option value="volunteers">Bénévoles</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-day" class="form-label">Jour de la semaine</label>
                        <select class="form-select" id="filter-day">
                            <option value="">Tous les jours</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-secondary" id="clear-filters-btn">
                                <i class="fas fa-eraser me-2"></i>Effacer les filtres
                            </button>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary" id="apply-filters-btn">
                                    <i class="fas fa-search me-2"></i>Appliquer les filtres
                                </button>
                                <button class="btn btn-success" id="export-pdf-btn">
                                    <i class="fas fa-file-pdf me-2"></i>Exporter en PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau des interventions -->
        <div class="card main-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-table me-2"></i>Données des Interventions</h4>
                <div>
                    <span id="results-count" class="badge bg-primary">0 intervention(s)</span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="interventions-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Jour</th>
                                <th>Type de culte</th>
                                <th>Lieu</th>
                                <th>Thème</th>
                                <th>Intervenant</th>
                                <th>Catégorie</th>
                                <th>Observations</th>
                            </tr>
                        </thead>
                        <tbody id="interventions-table-body">
                            <!-- Les données seront insérées ici dynamiquement -->
                            <tr id="no-data-row" style="display: none;">
                                <td colspan="8" class="text-center text-muted py-5">
                                    <i class="fas fa-database fa-3x mb-3"></i>
                                    <p>Aucune donnée disponible. Veuillez charger des interventions.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de personnalisation PDF -->
    <div class="modal fade" id="pdfCustomizationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Personnalisation du PDF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pdf-filename" class="form-label">Nom du fichier</label>
                                <input type="text" class="form-control" id="pdf-filename" value="Rapport_Interventions">
                            </div>
                            <div class="mb-3">
                                <label for="pdf-orientation" class="form-label">Orientation</label>
                                <select class="form-select" id="pdf-orientation">
                                    <option value="portrait">Portrait</option>
                                    <option value="landscape">Paysage</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pdf-format" class="form-label">Format</label>
                                <select class="form-select" id="pdf-format">
                                    <option value="a4">A4</option>
                                    <option value="a3">A3</option>
                                    <option value="letter">Lettre</option>
                                </select>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="pdf-include-logo" checked>
                                <label class="form-check-label" for="pdf-include-logo">
                                    Inclure le logo
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="pdf-margin-top" class="form-label">Marge haute</label>
                            <input type="number" class="form-control" id="pdf-margin-top" value="10" min="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="pdf-margin-right" class="form-label">Marge droite</label>
                                <input type="number" class="form-control" id="pdf-margin-right" value="10" min="0">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="pdf-margin-bottom" class="form-label">Marge basse</label>
                                <input type="number" class="form-control" id="pdf-margin-bottom" value="10" min="0">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="pdf-margin-left" class="form-label">Marge gauche</label>
                                <input type="number" class="form-control" id="pdf-margin-left" value="10" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary" id="confirm-pdf-export">Exporter</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Variables globales
        let interventions = [];
        let intervenantsDB = [];

        // Charger les données dès que le DOM est prêt
        document.addEventListener('DOMContentLoaded', function() {
            initializeRapportPage();
        });

        function initializeRapportPage() {
            console.log('Initialisation de la page de rapport...');
            
            // Charger les données
            loadDataForReport();
            
            // Configurer les événements
            setupRapportEventListeners();
        }

        function loadDataForReport() {
            console.log('Chargement des données pour le rapport...');
            
            // 1. D'abord vérifier si des données sont passées dans l'URL
            loadPublishedDataFromURL();
            
            // 2. Si aucune donnée dans l'URL, charger depuis localStorage
            if (interventions.length === 0) {
                loadDataFromLocalStorage();
            }
            
            // 3. Si toujours aucune donnée, essayer de charger depuis Supabase
            if (interventions.length === 0) {
                loadDataFromSupabase();
            }
            
            // Mettre à jour l'affichage
            updateDisplay();
        }

        function loadPublishedDataFromURL() {
            console.log('Vérification des données dans l\'URL...');
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            if (dataParam) {
                try {
                    console.log('Données trouvées dans l\'URL, tentative de décodage...');
                    
                    // Décoder les données
                    let decodedData;
                    try {
                        // Première méthode de décodage
                        decodedData = decodeURIComponent(atob(dataParam));
                    } catch (e1) {
                        console.log('Première méthode de décodage échouée, tentative alternative...');
                        // Méthode alternative
                        decodedData = atob(dataParam);
                    }
                    
                    console.log('Données décodées:', decodedData);
                    
                    const data = JSON.parse(decodedData);
                    
                    // Extraire les interventions
                    if (data.interventions && Array.isArray(data.interventions)) {
                        interventions = data.interventions;
                        console.log(`${interventions.length} interventions chargées depuis l'URL`);
                    }
                    
                    // Extraire les intervenants
                    if (data.intervenantsDB && Array.isArray(data.intervenantsDB)) {
                        intervenantsDB = data.intervenantsDB;
                    } else if (data.intervenants && Array.isArray(data.intervenants)) {
                        intervenantsDB = data.intervenants;
                    }
                    
                    // Charger le thème
                    if (data.theme) {
                        changeTheme(data.theme);
                    }
                    
                    showAlert('Données publiées chargées avec succès depuis l\'URL', 'success');
                    
                } catch (error) {
                    console.error('Erreur lors du chargement des données depuis l\'URL:', error);
                    showAlert('Impossible de charger les données depuis l\'URL. Vérifiez que le lien est correct.', 'warning');
                }
            }
        }

        function loadDataFromLocalStorage() {
            console.log('Chargement des données depuis localStorage...');
            
            // Essayer différentes clés possibles
            const possibleKeys = [
                'churchPlanningDataEncrypted',
                'churchPlanningData',
                'planningData',
                'planning_data'
            ];
            
            for (const key of possibleKeys) {
                try {
                    const savedData = localStorage.getItem(key);
                    if (savedData) {
                        console.log(`Données trouvées avec la clé: ${key}`);
                        const data = JSON.parse(savedData);
                        
                        // Extraire les interventions
                        if (data.interventions && Array.isArray(data.interventions)) {
                            interventions = data.interventions;
                            console.log(`${interventions.length} interventions chargées depuis localStorage`);
                        }
                        
                        // Extraire les intervenants
                        if (data.intervenantsDB && Array.isArray(data.intervenantsDB)) {
                            intervenantsDB = data.intervenantsDB;
                        } else if (data.intervenants && Array.isArray(data.intervenants)) {
                            intervenantsDB = data.intervenants;
                        }
                        
                        // Charger le thème
                        if (data.theme) {
                            changeTheme(data.theme);
                        }
                        
                        if (interventions.length > 0) {
                            showAlert(`${interventions.length} interventions chargées depuis la sauvegarde locale`, 'success');
                            break;
                        }
                    }
                } catch (e) {
                    console.error(`Erreur lors du chargement de ${key}:`, e);
                }
            }
            
            // Si on a des interventions mais pas d'intervenants, charger les intervenants par défaut
            if (interventions.length > 0 && intervenantsDB.length === 0) {
                loadDefaultIntervenants();
            }
        }

        function loadDefaultIntervenants() {
            // Charger les intervenants par défaut
            intervenantsDB = [
                { id: 1, title: "Pasteur", firstName: "Christophe", lastName: "SATCHI AKOUETE", category: "clergy" },
                { id: 2, title: "Diacre", firstName: "Dieudonné", lastName: "N'DIMONTE", category: "clergy" },
                { id: 3, title: "Mr", firstName: "Joël", lastName: "SENOUWA", category: "members" },
                { id: 4, title: "Mr", firstName: "Michel", lastName: "MOUDA", category: "members" },
                { id: 5, title: "Mr", firstName: "Jonas", lastName: "KPANATCHE", category: "members" },
                { id: 6, title: "Mr", firstName: "Ekué", lastName: "DAVI", category: "members" },
                { id: 7, title: "Mme", firstName: "ODETTE", lastName: "N'TCHA", category: "members" },
                { id: 8, title: "Mme", firstName: "SYLVIE", lastName: "DOKO", category: "members" },
                { id: 9, title: "Diacre", firstName: "Robert", lastName: "NOUGBONAGNI", category: "clergy" },
                { id: 10, title: "Mme", firstName: "Rébecca", lastName: "N'DAH", category: "members" },
                { id: 11, title: "Mme", firstName: "Pierrette", lastName: "ALOYA", category: "members" },
                { id: 12, title: "Mr", firstName: "GuY", lastName: "LOKOSSOU", category: "members" },
                { id: 13, title: "Mme", firstName: "Grace", lastName: "PASTEUR", category: "members" },
                { id: 14, title: "Mr", firstName: "Ezéchiel", lastName: "AKOMEDI", category: "members" },
                { id: 15, title: "Diacre", firstName: "Jonas", lastName: "MEMEGNON", category: "clergy" },
                { id: 16, title: "Mme", firstName: "Reine", lastName: "N'DIMONTE", category: "members" },
                { id: 17, title: "Mme", firstName: "Rebecca", lastName: "SENOUWA", category: "members" },
                { id: 18, title: "Mme", firstName: "KOMBETO", lastName: "", category: "members" },
                { id: 19, title: "Mme", firstName: "N'DAH", lastName: "REBECCA", category: "members" },
                { id: 20, title: "Mlle", firstName: "Sandra", lastName: "DJIHENTO", category: "members" }
            ];
        }

        async function loadDataFromSupabase() {
            console.log('Tentative de chargement depuis Supabase...');
            
            // Vous devez avoir configuré Supabase dans un fichier séparé
            // Si vous avez un fichier supabase-config.js, il devrait être inclus avant ce script
            if (typeof window.supabase === 'undefined') {
                console.log('Supabase non configuré');
                return;
            }
            
            try {
                // Charger les interventions
                const { data: interventionsData, error: interventionsError } = await window.supabase
                    .from('interventions')
                    .select('*');
                    
                if (!interventionsError && interventionsData) {
                    interventions = interventionsData;
                    console.log(`${interventions.length} interventions chargées depuis Supabase`);
                }
                
                // Charger les intervenants
                const { data: intervenantsData, error: intervenantsError } = await window.supabase
                    .from('intervenants')
                    .select('*');
                    
                if (!intervenantsError && intervenantsData) {
                    intervenantsDB = intervenantsData;
                }
                
                if (interventions.length > 0) {
                    showAlert(`${interventions.length} interventions chargées depuis le cloud`, 'success');
                }
                
            } catch (error) {
                console.error('Erreur lors du chargement depuis Supabase:', error);
            }
        }

        function updateDisplay() {
            console.log('Mise à jour de l\'affichage...');
            
            // Afficher/masquer le message "aucune donnée"
            const noDataRow = document.getElementById('no-data-row');
            if (noDataRow) {
                if (interventions.length === 0) {
                    noDataRow.style.display = '';
                } else {
                    noDataRow.style.display = 'none';
                }
            }
            
            // Mettre à jour le tableau
            displayInterventions(interventions);
            
            // Mettre à jour les filtres
            updateFilterOptions();
        }

        function displayInterventions(interventionsToShow) {
            const tableBody = document.getElementById('interventions-table-body');
            if (!tableBody) return;
            
            // Garder la ligne "aucune donnée"
            const noDataRow = document.getElementById('no-data-row');
            
            // Supprimer toutes les lignes sauf "aucune donnée"
            const rowsToRemove = tableBody.querySelectorAll('tr:not(#no-data-row)');
            rowsToRemove.forEach(row => row.remove());
            
            // Si aucune intervention à afficher
            if (!interventionsToShow || interventionsToShow.length === 0) {
                if (noDataRow) {
                    noDataRow.style.display = '';
                }
                document.getElementById('results-count').textContent = '0 intervention(s)';
                return;
            }
            
            // Masquer la ligne "aucune donnée"
            if (noDataRow) {
                noDataRow.style.display = 'none';
            }
            
            // Ajouter les interventions
            interventionsToShow.forEach(intervention => {
                // Trouver l'intervenant correspondant
                let category = 'inconnue';
                if (intervention.firstName && intervention.lastName) {
                    const intervenant = intervenantsDB.find(iv => 
                        iv.firstName === intervention.firstName && iv.lastName === intervention.lastName
                    );
                    
                    if (intervenant && intervenant.category) {
                        category = intervenant.category;
                    }
                }
                
                // Définir les labels des catégories
                const categoryLabels = {
                    'clergy': 'Clergé',
                    'members': 'Membres',
                    'singers': 'Chanteurs',
                    'musicians': 'Musiciens',
                    'technical': 'Technique',
                    'volunteers': 'Bénévoles',
                    'inconnue': 'Inconnue'
                };
                
                // Créer la ligne
                const row = document.createElement('tr');
                
                // S'assurer que tous les champs existent
                const date = intervention.date || '';
                const dayOfWeek = intervention.dayOfWeek || getDayOfWeekFromDate(date);
                const cultType = intervention.cultType || '';
                const place = intervention.place || '';
                const theme = intervention.theme || '';
                const fullName = intervention.fullName || 
                                ((intervention.title || '') + ' ' + (intervention.firstName || '') + ' ' + (intervention.lastName || '')).trim();
                const observations = intervention.observations || '';
                
                row.innerHTML = `
                    <td>${formatDate(date)}</td>
                    <td>${dayOfWeek}</td>
                    <td>${cultType}</td>
                    <td>${place}</td>
                    <td>${theme}</td>
                    <td>${fullName}</td>
                    <td>${categoryLabels[category] || category}</td>
                    <td>${observations}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Mettre à jour le compteur
            document.getElementById('results-count').textContent = `${interventionsToShow.length} intervention(s)`;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString; // Retourner tel quel si ce n'est pas une date valide
                }
                return date.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function getDayOfWeekFromDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                
                const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                return days[date.getDay()];
            } catch (error) {
                return '';
            }
        }

        function updateFilterOptions() {
            // Récupérer toutes les valeurs uniques
            const cultTypes = [...new Set(interventions.map(i => i.cultType).filter(Boolean))];
            const places = [...new Set(interventions.map(i => i.place).filter(Boolean))];
            const intervenants = [...new Set(interventions.map(i => {
                if (i.fullName) return i.fullName;
                return ((i.title || '') + ' ' + (i.firstName || '') + ' ' + (i.lastName || '')).trim();
            }).filter(Boolean))];
            const days = [...new Set(interventions.map(i => {
                if (i.dayOfWeek) return i.dayOfWeek;
                return getDayOfWeekFromDate(i.date);
            }).filter(Boolean))];
            
            // Mettre à jour le filtre des types de culte
            const cultTypeSelect = document.getElementById('filter-cult-type');
            if (cultTypeSelect) {
                let options = '<option value="">Tous les types</option>';
                cultTypes.forEach(type => {
                    options += `<option value="${type}">${type}</option>`;
                });
                cultTypeSelect.innerHTML = options;
            }
            
            // Mettre à jour le filtre des lieux
            const placeSelect = document.getElementById('filter-place');
            if (placeSelect) {
                let options = '<option value="">Tous les lieux</option>';
                places.forEach(place => {
                    options += `<option value="${place}">${place}</option>`;
                });
                placeSelect.innerHTML = options;
            }
            
            // Mettre à jour le filtre des intervenants
            const intervenantSelect = document.getElementById('filter-intervenant');
            if (intervenantSelect) {
                let options = '<option value="">Tous les intervenants</option>';
                intervenants.forEach(name => {
                    options += `<option value="${name}">${name}</option>`;
                });
                intervenantSelect.innerHTML = options;
            }
            
            // Mettre à jour le filtre des jours
            const daySelect = document.getElementById('filter-day');
            if (daySelect) {
                let options = '<option value="">Tous les jours</option>';
                days.forEach(day => {
                    options += `<option value="${day}">${day}</option>`;
                });
                daySelect.innerHTML = options;
            }
        }

        function setupRapportEventListeners() {
            console.log('Configuration des événements...');
            
            // Filtres
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }
            
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', clearFilters);
            }
            
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', showPdfCustomizationModal);
            }
            
            const confirmPdfExport = document.getElementById('confirm-pdf-export');
            if (confirmPdfExport) {
                confirmPdfExport.addEventListener('click', generatePDF);
            }
            
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    showAlert('Rechargement des données...', 'info');
                    loadDataForReport();
                });
            }
            
            const publishBtn = document.getElementById('publish-btn');
            if (publishBtn) {
                publishBtn.addEventListener('click', publishData);
            }
            
            // Thèmes
            const themeButtons = document.querySelectorAll('.theme-btn');
            themeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const theme = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    changeTheme(theme);
                });
            });
        }

        function applyFilters() {
            const startDate = document.getElementById('filter-date-start').value;
            const endDate = document.getElementById('filter-date-end').value;
            const cultType = document.getElementById('filter-cult-type').value;
            const place = document.getElementById('filter-place').value;
            const intervenant = document.getElementById('filter-intervenant').value;
            const category = document.getElementById('filter-category').value;
            const day = document.getElementById('filter-day').value;
            
            let filteredInterventions = [...interventions];
            
            // Filtre par date
            if (startDate) {
                filteredInterventions = filteredInterventions.filter(i => {
                    if (!i.date) return false;
                    return i.date >= startDate;
                });
            }
            
            if (endDate) {
                filteredInterventions = filteredInterventions.filter(i => {
                    if (!i.date) return false;
                    return i.date <= endDate;
                });
            }
            
            // Filtre par type de culte
            if (cultType) {
                filteredInterventions = filteredInterventions.filter(i => i.cultType === cultType);
            }
            
            // Filtre par lieu
            if (place) {
                filteredInterventions = filteredInterventions.filter(i => i.place === place);
            }
            
            // Filtre par intervenant
            if (intervenant) {
                filteredInterventions = filteredInterventions.filter(i => {
                    const fullName = i.fullName || 
                                   ((i.title || '') + ' ' + (i.firstName || '') + ' ' + (i.lastName || '')).trim();
                    return fullName === intervenant;
                });
            }
            
            // Filtre par catégorie
            if (category) {
                filteredInterventions = filteredInterventions.filter(i => {
                    const intervenant = intervenantsDB.find(iv => 
                        iv.firstName === i.firstName && iv.lastName === i.lastName
                    );
                    return intervenant && intervenant.category === category;
                });
            }
            
            // Filtre par jour
            if (day) {
                filteredInterventions = filteredInterventions.filter(i => {
                    const dayOfWeek = i.dayOfWeek || getDayOfWeekFromDate(i.date);
                    return dayOfWeek === day;
                });
            }
            
            // Afficher les résultats
            displayInterventions(filteredInterventions);
        }

        function clearFilters() {
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-cult-type').value = '';
            document.getElementById('filter-place').value = '';
            document.getElementById('filter-intervenant').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-day').value = '';
            
            displayInterventions(interventions);
        }

        function showPdfCustomizationModal() {
            // Vérifier qu'il y a des données à exporter
            if (interventions.length === 0) {
                showAlert('Aucune donnée à exporter. Veuillez d\'abord charger des interventions.', 'warning');
                return;
            }
            
            // Ouvrir la modale
            const modal = new bootstrap.Modal(document.getElementById('pdfCustomizationModal'));
            modal.show();
        }

        async function generatePDF() {
            try {
                // Récupérer les options
                const fileName = document.getElementById('pdf-filename').value || 'Rapport_Interventions';
                const orientation = document.getElementById('pdf-orientation').value;
                const format = document.getElementById('pdf-format').value;
                const includeLogo = document.getElementById('pdf-include-logo').checked;
                const margins = {
                    top: parseInt(document.getElementById('pdf-margin-top').value) || 10,
                    right: parseInt(document.getElementById('pdf-margin-right').value) || 10,
                    bottom: parseInt(document.getElementById('pdf-margin-bottom').value) || 10,
                    left: parseInt(document.getElementById('pdf-margin-left').value) || 10
                };
                
                // Récupérer les interventions filtrées actuelles
                const tableRows = document.querySelectorAll('#interventions-table-body tr:not(#no-data-row)');
                if (tableRows.length === 0) {
                    showAlert('Aucune intervention à exporter.', 'warning');
                    return;
                }
                
                // Générer le PDF
                await generatePDFReport(tableRows, {
                    fileName,
                    orientation,
                    format,
                    includeLogo,
                    margins
                });
                
                // Fermer la modale
                const modal = bootstrap.Modal.getInstance(document.getElementById('pdfCustomizationModal'));
                modal.hide();
                
            } catch (error) {
                console.error('Erreur lors de la génération du PDF:', error);
                showAlert('Erreur lors de la génération du PDF: ' + error.message, 'danger');
            }
        }

        async function generatePDFReport(tableRows, options) {
            // Vérifier que jsPDF est disponible
            if (typeof window.jspdf === 'undefined') {
                showAlert('La bibliothèque PDF n\'est pas chargée correctement.', 'danger');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            
            // Créer un nouveau document PDF
            const doc = new jsPDF({
                orientation: options.orientation,
                unit: 'mm',
                format: options.format
            });
            
            // Titre
            doc.setFontSize(18);
            doc.setTextColor(0, 0, 128);
            doc.text('RAPPORT DÉTAILLÉ DES INTERVENTIONS', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Église BERACA - Assemblées de Dieu du Bénin', 105, 28, { align: 'center' });
            
            // Date de génération
            const now = new Date();
            const dateStr = now.toLocaleDateString('fr-FR');
            doc.setFontSize(10);
            doc.text(`Généré le: ${dateStr}`, 195, 10, { align: 'right' });
            
            // En-têtes du tableau
            const headers = [
                'Date',
                'Jour',
                'Type de culte',
                'Lieu',
                'Thème',
                'Intervenant',
                'Catégorie',
                'Observations'
            ];
            
            // Extraire les données du tableau
            const data = [];
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                data.push(rowData);
            });
            
            // Ajouter le tableau
            doc.autoTable({
                head: [headers],
                body: data,
                startY: 35,
                margin: options.margins,
                styles: {
                    fontSize: 9,
                    cellPadding: 3,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                columnStyles: {
                    0: { cellWidth: 25 }, // Date
                    1: { cellWidth: 20 }, // Jour
                    2: { cellWidth: 30 }, // Type
                    3: { cellWidth: 25 }, // Lieu
                    4: { cellWidth: 40 }, // Thème
                    5: { cellWidth: 35 }, // Intervenant
                    6: { cellWidth: 25 }, // Catégorie
                    7: { cellWidth: 40 }  // Observations
                },
                didDrawPage: function(data) {
                    // Numéro de page
                    doc.setFontSize(10);
                    doc.text(
                        `Page ${data.pageNumber}`,
                        doc.internal.pageSize.width / 2,
                        doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }
            });
            
            // Sauvegarder le PDF
            doc.save(`${options.fileName}.pdf`);
            
            showAlert('PDF généré avec succès !', 'success');
        }

        function publishData() {
            if (interventions.length === 0) {
                showAlert('Aucune intervention à publier.', 'warning');
                return;
            }
            
            try {
                // Préparer les données à publier
                const dataToPublish = {
                    interventions: interventions,
                    intervenantsDB: intervenantsDB,
                    theme: document.body.className.replace('theme-', ''),
                    publishedAt: new Date().toISOString()
                };
                
                // Convertir en JSON
                const jsonData = JSON.stringify(dataToPublish);
                
                // Encoder en base64 pour l'URL
                const base64Data = btoa(unescape(encodeURIComponent(jsonData)));
                
                // Créer l'URL de partage
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?data=${base64Data}`;
                
                // Créer une modale pour afficher le lien
                const modalHtml = `
                    <div class="modal fade" id="shareModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Lien de partage</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Voici le lien pour partager ces données :</p>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="share-url" value="${shareUrl}" readonly>
                                        <button class="btn btn-outline-secondary" type="button" id="copy-url-btn">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Partagez ce lien pour permettre à d'autres de voir ce rapport.
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ajouter la modale au document
                const existingModal = document.getElementById('shareModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Afficher la modale
                const modal = new bootstrap.Modal(document.getElementById('shareModal'));
                modal.show();
                
                // Configurer le bouton de copie
                document.getElementById('copy-url-btn').addEventListener('click', function() {
                    const urlInput = document.getElementById('share-url');
                    urlInput.select();
                    document.execCommand('copy');
                    
                    // Changer l'icône temporairement
                    const icon = this.querySelector('i');
                    const originalClass = icon.className;
                    icon.className = 'fas fa-check';
                    
                    setTimeout(() => {
                        icon.className = originalClass;
                    }, 2000);
                    
                    showAlert('Lien copié dans le presse-papiers !', 'success');
                });
                
            } catch (error) {
                console.error('Erreur lors de la publication:', error);
                showAlert('Erreur lors de la publication: ' + error.message, 'danger');
            }
        }

        function changeTheme(theme) {
            // Supprimer toutes les classes de thème
            const allowedThemes = ['light', 'dark', 'neon', 'galaxy', 'rainbow', 'high-contrast', 'pastel'];
            allowedThemes.forEach(t => {
                document.body.classList.remove(`theme-${t}`);
            });
            
            // Ajouter le nouveau thème
            document.body.classList.add(`theme-${theme}`);
        }

        function showAlert(message, type) {
            // Supprimer les alertes existantes
            const existingAlerts = document.querySelectorAll('.alert-custom');
            existingAlerts.forEach(alert => alert.remove());
            
            // Créer la nouvelle alerte
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-custom alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Style de l'alerte
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            // Ajouter au document
            document.body.appendChild(alertDiv);
            
            // Supprimer automatiquement après 5 secondes
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Pour compatibilité
        function loadFromLocalStorage() {
            return loadDataFromLocalStorage();
        }

        function loadPublishedDataForReport() {
            return loadPublishedDataFromURL();
        }

        function cleanupExpiredDataForReport() {
            // Ne rien faire pour le moment
        }
    </script>
</body>
</html>
