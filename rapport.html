<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport Détaillé - Planificateur d'Interventions</title>
    <link rel="icon" href="AD.jpeg" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
</head>
<body class="theme-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid d-flex align-items-center">
            <a class="navbar-brand" href="index.html">
                <img src="AD.jpeg" alt="Logo AD" class="img-fluid" style="width: 80px; height: 80px; object-fit: contain; border-radius: 8px; margin-right: 15px;">
                <span class="glow-text">Rapport Détaillé</span>
            </a>

            <div class="theme-selector">
                <div class="theme-btn theme-light-btn" title="Clair" onclick="changeTheme('light')"></div>
                <div class="theme-btn theme-dark-btn" title="Sombre" onclick="changeTheme('dark')"></div>
                <div class="theme-btn theme-neon-btn" title="Néon" onclick="changeTheme('neon')"></div>
                <div class="theme-btn theme-galaxy-btn" title="Galaxie" onclick="changeTheme('galaxy')"></div>
                <div class="theme-btn theme-rainbow-btn" title="Arc-en-ciel" onclick="changeTheme('rainbow')"></div>
                <div class="theme-btn theme-high-contrast-btn" title="Contraste élevé" onclick="changeTheme('high-contrast')">HC</div>
                <div class="theme-btn theme-pastel-btn" title="Pastel" onclick="changeTheme('pastel')">P</div>
            </div>

            <div class="navbar-text me-3">
                <span class="badge bg-warning text-dark">Église BERACA</span>
            </div>

            <div class="ms-3">
                <button class="btn btn-outline-info" id="help-btn" title="Aide">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>

            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown">
                    <i class="fas fa-globe me-1"></i>FR
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('fr')">Français</a></li>
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')">English</a></li>
                </ul>
            </div>


            <div class="ms-3">
                <button class="btn btn-outline-primary" id="publish-btn" title="Publier les données">
                    <i class="fas fa-share-alt"></i> Publier
                </button>
            </div>

        </div>
    </nav>

    <div class="container mt-4">
        <!-- En-tête -->
        <div class="ad-header mb-4">
            <h1><i class="fas fa-chart-bar me-2"></i>RAPPORT DÉTAILLÉ DES INTERVENTIONS</h1>
            <p>Suivi et analyse des interventions planifiées</p>
        </div>

        <!-- Filtres avancés -->
        <div class="card main-card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-filter me-2"></i>Filtres de Recherche</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="filter-date-start" class="form-label">Date de début</label>
                        <input type="date" class="form-control" id="filter-date-start">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filter-date-end" class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="filter-date-end">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filter-cult-type" class="form-label">Type de culte</label>
                        <select class="form-select" id="filter-cult-type">
                            <option value="">Tous les types</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="filter-place" class="form-label">Lieu</label>
                        <select class="form-select" id="filter-place">
                            <option value="">Tous les lieux</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="filter-intervenant" class="form-label">Intervenant</label>
                        <select class="form-select" id="filter-intervenant">
                            <option value="">Tous les intervenants</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-category" class="form-label">Catégorie</label>
                        <select class="form-select" id="filter-category">
                            <option value="">Toutes les catégories</option>
                            <option value="clergy">Clergé</option>
                            <option value="members">Membres</option>
                            <option value="singers">Chanteurs</option>
                            <option value="musicians">Musiciens</option>
                            <option value="technical">Technique</option>
                            <option value="volunteers">Bénévoles</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-day" class="form-label">Jour de la semaine</label>
                        <select class="form-select" id="filter-day">
                            <option value="">Tous les jours</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-secondary" id="clear-filters-btn">
                                <i class="fas fa-eraser me-2"></i>Effacer les filtres
                            </button>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary" id="apply-filters-btn">
                                    <i class="fas fa-search me-2"></i>Appliquer les filtres
                                </button>
                                <button class="btn btn-success" id="export-pdf-btn">
                                    <i class="fas fa-file-pdf me-2"></i>Exporter en PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau des interventions -->
        <div class="card main-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-table me-2"></i>Données des Interventions</h4>
                <div>
                    <span id="results-count" class="badge bg-primary">0 intervention(s)</span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="interventions-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Jour</th>
                                <th>Type de culte</th>
                                <th>Lieu</th>
                                <th>Thème</th>
                                <th>Intervenant</th>
                                <th>Catégorie</th>
                                <th>Observations</th>
                            </tr>
                        </thead>
                        <tbody id="interventions-table-body">
                            <!-- Les données seront insérées ici dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de personnalisation PDF -->
    <div class="modal fade" id="pdfCustomizationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Personnalisation du PDF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pdf-filename" class="form-label">Nom du fichier</label>
                                <input type="text" class="form-control" id="pdf-filename" value="Rapport_Interventions">
                            </div>
                            <div class="mb-3">
                                <label for="pdf-orientation" class="form-label">Orientation</label>
                                <select class="form-select" id="pdf-orientation">
                                    <option value="portrait">Portrait</option>
                                    <option value="landscape">Paysage</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pdf-format" class="form-label">Format</label>
                                <select class="form-select" id="pdf-format">
                                    <option value="a4">A4</option>
                                    <option value="a3">A3</option>
                                    <option value="letter">Lettre</option>
                                </select>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="pdf-include-logo" checked>
                                <label class="form-check-label" for="pdf-include-logo">
                                    Inclure le logo
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="pdf-margin-top" class="form-label">Marge haute</label>
                            <input type="number" class="form-control" id="pdf-margin-top" value="10" min="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="pdf-margin-right" class="form-label">Marge droite</label>
                            <input type="number" class="form-control" id="pdf-margin-right" value="10" min="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="pdf-margin-bottom" class="form-label">Marge basse</label>
                            <input type="number" class="form-control" id="pdf-margin-bottom" value="10" min="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="pdf-margin-left" class="form-label">Marge gauche</label>
                            <input type="number" class="form-control" id="pdf-margin-left" value="10" min="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="confirm-pdf-export">Exporter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Charger les données des interventions
        document.addEventListener('DOMContentLoaded', function() {
            initializeRapportPage();
        });

        // Données globales pour la page de rapport
        let interventions = [];
        let intervenantsDB = [
            { id: 1, title: "Pasteur", firstName: "Christophe", lastName: "SATCHI AKOUETE", category: "clergy" },
            { id: 2, title: "Diacre", firstName: "Dieudonné", lastName: "N'DIMONTE", category: "clergy" },
            { id: 3, title: "Mr", firstName: "Joël", lastName: "SENOUWA", category: "members" },
            { id: 4, title: "Mr", firstName: "Michel", lastName: "MOUDA", category: "members" },
            { id: 5, title: "Mr", firstName: "Jonas", lastName: "KPANATCHE", category: "members" },
            { id: 6, title: "Mr", firstName: "Ekué", lastName: "DAVI", category: "members" },
            { id: 7, title: "Mme", firstName: "ODETTE", lastName: "N'TCHA", category: "members" },
            { id: 8, title: "Mme", firstName: "SYLVIE", lastName: "DOKO", category: "members" },
            { id: 9, title: "Diacre", firstName: "Robert", lastName: "NOUGBONAGNI", category: "clergy" },
            { id: 10, title: "Mme", firstName: "Rébecca", lastName: "N'DAH", category: "members" },
            { id: 11, title: "Mme", firstName: "Pierrette", lastName: "ALOYA", category: "members" },
            { id: 12, title: "Mr", firstName: "GuY", lastName: "LOKOSSOU", category: "members" },
            { id: 13, title: "Mme", firstName: "Grace", lastName: "PASTEUR", category: "members" },
            { id: 14, title: "Mr", firstName: "Ezéchiel", lastName: "AKOMEDI", category: "members" },
            { id: 15, title: "Diacre", firstName: "Jonas", lastName: "MEMEGNON", category: "clergy" },
            { id: 16, title: "Mme", firstName: "Reine", lastName: "N'DIMONTE", category: "members" },
            { id: 17, title: "Mme", firstName: "Rebecca", lastName: "SENOUWA", category: "members" },
            { id: 18, title: "Mme", firstName: "KOMBETO", lastName: "", category: "members" },
            { id: 19, title: "Mme", firstName: "N'DAH", lastName: "REBECCA", category: "members" },
            { id: 20, title: "Mlle", firstName: "Sandra", lastName: "DJIHENTO", category: "members" }
        ];

        function initializeRapportPage() {
            // Charger les données sauvegardées
            loadFromLocalStorage();

            // Charger les données publiées si présentes dans l'URL
            loadPublishedDataForReport();

            // Nettoyer les données expirées
            cleanupExpiredDataForReport();

            // Mettre à jour les filtres
            updateFilterOptions();

            // Afficher toutes les interventions initialement
            displayInterventions(interventions);

            // Afficher un message selon le nombre d'interventions
            if (interventions.length === 0) {
                showAlert("Aucune donnée disponible. Si vous avez un lien de publication, assurez-vous qu'il est correct.", "info");
            } else {
                showAlert(`${interventions.length} intervention(s) chargée(s) avec succès.`, "success");
            }

            // Configurer les événements
            setupRapportEventListeners();
        }

        function setupRapportEventListeners() {
            // Événements pour les filtres
            document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
            document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
            document.getElementById('export-pdf-btn').addEventListener('click', showPdfCustomizationModal);
            
            // Événements pour la personnalisation PDF
            document.getElementById('confirm-pdf-export').addEventListener('click', function() {
                const options = {
                    orientation: document.getElementById('pdf-orientation').value,
                    format: document.getElementById('pdf-format').value,
                    margins: {
                        top: parseInt(document.getElementById('pdf-margin-top').value) || 10,
                        right: parseInt(document.getElementById('pdf-margin-right').value) || 10,
                        bottom: parseInt(document.getElementById('pdf-margin-bottom').value) || 10,
                        left: parseInt(document.getElementById('pdf-margin-left').value) || 10
                    },
                    includeLogo: document.getElementById('pdf-include-logo').checked
                };

                const fileName = document.getElementById('pdf-filename').value || 'Rapport_Interventions';

                // Fermer la modale
                const modal = bootstrap.Modal.getInstance(document.getElementById('pdfCustomizationModal'));
                modal.hide();

                // Générer le PDF
                generatePDFReportWrapper(options, fileName);
            });
        }

        function updateFilterOptions() {
            // Remplir les filtres avec les données existantes
            const cultTypes = [...new Set(interventions.map(i => i.cultType))].filter(Boolean);
            const places = [...new Set(interventions.map(i => i.place))].filter(Boolean);
            const intervenants = [...new Set(interventions.map(i => i.fullName))].filter(Boolean);
            const days = [...new Set(interventions.map(i => i.dayOfWeek))].filter(Boolean);
            
            // Remplir le filtre des types de culte
            const cultTypeSelect = document.getElementById('filter-cult-type');
            cultTypeSelect.innerHTML = '<option value="">Tous les types</option>';
            cultTypes.forEach(type => {
                cultTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
            });
            
            // Remplir le filtre des lieux
            const placeSelect = document.getElementById('filter-place');
            placeSelect.innerHTML = '<option value="">Tous les lieux</option>';
            places.forEach(place => {
                placeSelect.innerHTML += `<option value="${place}">${place}</option>`;
            });
            
            // Remplir le filtre des intervenants
            const intervenantSelect = document.getElementById('filter-intervenant');
            intervenantSelect.innerHTML = '<option value="">Tous les intervenants</option>';
            intervenants.forEach(name => {
                intervenantSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
            
            // Remplir le filtre des jours
            const daySelect = document.getElementById('filter-day');
            daySelect.innerHTML = '<option value="">Tous les jours</option>';
            days.forEach(day => {
                daySelect.innerHTML += `<option value="${day}">${day}</option>`;
            });
        }

        function applyFilters() {
            const startDate = document.getElementById('filter-date-start').value;
            const endDate = document.getElementById('filter-date-end').value;
            const cultType = document.getElementById('filter-cult-type').value;
            const place = document.getElementById('filter-place').value;
            const intervenant = document.getElementById('filter-intervenant').value;
            const category = document.getElementById('filter-category').value;
            const day = document.getElementById('filter-day').value;

            let filteredInterventions = [...interventions];

            // Filtre par date de début
            if (startDate) {
                filteredInterventions = filteredInterventions.filter(i => i.date >= startDate);
            }

            // Filtre par date de fin
            if (endDate) {
                filteredInterventions = filteredInterventions.filter(i => i.date <= endDate);
            }

            // Filtre par type de culte
            if (cultType) {
                filteredInterventions = filteredInterventions.filter(i => i.cultType === cultType);
            }

            // Filtre par lieu
            if (place) {
                filteredInterventions = filteredInterventions.filter(i => i.place === place);
            }

            // Filtre par intervenant
            if (intervenant) {
                filteredInterventions = filteredInterventions.filter(i => i.fullName === intervenant);
            }

            // Filtre par catégorie
            if (category) {
                filteredInterventions = filteredInterventions.filter(i => {
                    const intervenant = intervenantsDB.find(iv => 
                        iv.firstName === i.firstName && iv.lastName === i.lastName
                    );
                    return intervenant && intervenant.category === category;
                });
            }

            // Filtre par jour
            if (day) {
                filteredInterventions = filteredInterventions.filter(i => i.dayOfWeek === day);
            }

            // Afficher les interventions filtrées
            displayInterventions(filteredInterventions);
        }

        function clearFilters() {
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-cult-type').value = '';
            document.getElementById('filter-place').value = '';
            document.getElementById('filter-intervenant').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-day').value = '';

            displayInterventions(interventions);
        }

        function displayInterventions(interventionsToShow) {
            const tableBody = document.getElementById('interventions-table-body');
            tableBody.innerHTML = '';

            interventionsToShow.forEach(intervention => {
                const intervenant = intervenantsDB.find(iv => 
                    iv.firstName === intervention.firstName && iv.lastName === intervention.lastName
                );
                
                const category = intervenant ? intervenant.category : 'inconnue';
                
                const categoryLabels = {
                    'clergy': 'Clergé',
                    'members': 'Membres',
                    'singers': 'Chanteurs',
                    'musicians': 'Musiciens',
                    'technical': 'Technique',
                    'volunteers': 'Bénévoles'
                };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(intervention.date)}</td>
                    <td>${intervention.dayOfWeek}</td>
                    <td>${intervention.cultType}</td>
                    <td>${intervention.place}</td>
                    <td>${intervention.theme || ''}</td>
                    <td>${intervention.fullName}</td>
                    <td>${categoryLabels[category] || 'Inconnue'}</td>
                    <td>${intervention.observations || ''}</td>
                `;
                tableBody.appendChild(row);
            });

            // Mettre à jour le compteur de résultats
            document.getElementById('results-count').textContent = `${interventionsToShow.length} intervention(s)`;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function generatePDFReportWrapper(options, fileName) {
            // Récupérer les interventions filtrées actuelles
            const tableRows = document.querySelectorAll('#interventions-table-body tr');
            if (tableRows.length === 0) {
                showAlert('Aucune intervention à exporter.', 'warning');
                return;
            }

            // Générer un tableau des interventions à partir des lignes du tableau affiché
            const interventionsToShow = [];
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) { // S'assurer qu'il y a suffisamment de cellules
                    const intervention = {
                        date: reverseDateFormat(cells[0].textContent.trim()),
                        dayOfWeek: cells[1].textContent.trim(),
                        cultType: cells[2].textContent.trim(),
                        place: cells[3].textContent.trim(),
                        theme: cells[4].textContent.trim(),
                        fullName: cells[5].textContent.trim(),
                        firstName: '', // Ces champs seront extraits de fullName si possible
                        lastName: '',
                        observations: cells[7].textContent.trim()
                    };

                    // Extraire prénom et nom de la chaîne complète
                    const nameParts = intervention.fullName.split(' ');
                    if (nameParts.length >= 2) {
                        intervention.firstName = nameParts[0];
                        intervention.lastName = nameParts.slice(1).join(' ');
                    } else {
                        intervention.firstName = intervention.fullName;
                    }

                    interventionsToShow.push(intervention);
                }
            });

            // Appeler la fonction centrale dans script.js
            window.generatePDFReport(interventionsToShow, options, fileName);
        }

        // Fonction utilitaire pour inverser le format de date (de dd/mm/yyyy à yyyy-mm-dd)
        function reverseDateFormat(dateStr) {
            if (!dateStr || dateStr.length !== 10) return dateStr; // Si le format n'est pas dd/mm/yyyy, retourner tel quel
            const parts = dateStr.split('/');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        // Fonction pour charger les données sauvegardées (copiée de script.js)
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('planningData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    interventions = data.interventions || [];
                    intervenantsDB = data.intervenantsDB || intervenantsDB;
                    console.log(`Données chargées: ${interventions.length} interventions, ${intervenantsDB.length} intervenants`);
                }
            } catch (e) {
                console.error('Erreur lors du chargement des données:', e);
            }
        }

        // Fonction pour afficher les alertes (copiée de script.js)
        function showAlert(message, type = 'info') {
            // Supprimer les alertes existantes
            const existingAlert = document.querySelector('.alert-custom');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-custom`;
            alertDiv.textContent = message;

            document.body.appendChild(alertDiv);

            // Supprimer l'alerte après 5 secondes
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Fonction pour changer de thème (copiée de script.js)
        function changeTheme(theme) {
            // Valider que le thème est autorisé pour éviter les injections CSS
            const allowedThemes = ['light', 'dark', 'neon', 'galaxy', 'rainbow', 'high-contrast', 'pastel'];
            if (!allowedThemes.includes(theme)) {
                console.warn(`Thème non autorisé : ${theme}`);
                return;
            }

            document.body.className = 'theme-' + theme;
        }

        // Fonction pour charger les données publiées à partir de l'URL (spécifique à la page de rapport)
        function loadPublishedDataForReport() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');

            if (encodedData) {
                try {
                    // Décoder les données
                    const decodedData = decodeURIComponent(atob(encodedData).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));

                    const data = JSON.parse(decodedData);

                    // Charger les données dans l'application
                    interventions = data.interventions || [];
                    intervenantsDB = data.intervenantsDB || intervenantsDB;

                    // Charger le thème
                    if (data.theme) {
                        changeTheme(data.theme);
                    }

                    // Mettre à jour les interfaces
                    updateFilterOptions();
                    displayInterventions(interventions);

                    showAlert('Données publiées chargées avec succès !', 'success');
                } catch (error) {
                    console.error('Erreur lors du chargement des données publiées:', error);
                    showAlert('Erreur lors du chargement des données publiées: ' + error.message, 'danger');
                }
            }
        }

        // Fonction pour nettoyer les données expirées (spécifique à la page de rapport)
        function cleanupExpiredDataForReport() {
            // Cette fonction est incluse pour assurer la compatibilité avec les fonctions de la page principale
            // Pour le moment, ne fait rien car les publications sont permanentes
            // Cette fonction est conservée pour une éventuelle utilisation future
        }

        // Fonction pour charger les données sauvegardées
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('planningData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    interventions = data.interventions || [];
                    intervenantsDB = data.intervenantsDB || intervenantsDB;
                    console.log(`Données chargées: ${interventions.length} interventions, ${intervenantsDB.length} intervenants`);
                }
            } catch (e) {
                console.error('Erreur lors du chargement des données:', e);
            }
        }

        // Fonction pour charger les données publiées à partir de l'URL (spécifique à la page de rapport)
        function loadPublishedDataForReport() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');

            if (encodedData) {
                try {
                    // Décoder les données
                    const decodedData = decodeURIComponent(atob(encodedData).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));

                    const data = JSON.parse(decodedData);

                    // Charger les données dans l'application
                    interventions = data.interventions || [];
                    intervenantsDB = data.intervenantsDB || intervenantsDB;

                    // Charger le thème
                    if (data.theme) {
                        changeTheme(data.theme);
                    }

                    // Mettre à jour les interfaces
                    updateFilterOptions();
                    displayInterventions(interventions);

                    showAlert('Données publiées chargées avec succès !', 'success');
                } catch (error) {
                    console.error('Erreur lors du chargement des données publiées:', error);
                    showAlert('Erreur lors du chargement des données publiées: ' + error.message, 'danger');
                }
            } else {
                // Charger les données sauvegardées localement si aucune donnée n'est fournie via l'URL
                loadFromLocalStorage();

                // Charger les données synchronisées automatiquement si aucune donnée n'est encore présente
                if (interventions.length === 0) {
                    loadAutoSyncData();
                }
            }
        }

        // Fonction pour charger les données synchronisées automatiquement
        function loadAutoSyncData() {
            try {
                const syncData = localStorage.getItem('autoSyncData');
                if (syncData) {
                    const data = JSON.parse(syncData);
                    interventions = data.interventions || [];
                    intervenantsDB = data.intervenantsDB || intervenantsDB;

                    // Mettre à jour les interfaces
                    updateFilterOptions();
                    displayInterventions(interventions);

                    console.log(`Données synchronisées automatiquement chargées: ${interventions.length} interventions`);
                }
            } catch (e) {
                console.error('Erreur lors du chargement des données synchronisées:', e);
            }
        }


        // Fonction pour mettre à jour les options de filtre
        function updateFilterOptions() {
            // Remplir les filtres avec les données existantes
            const cultTypes = [...new Set(interventions.map(i => i.cultType))].filter(Boolean);
            const places = [...new Set(interventions.map(i => i.place))].filter(Boolean);
            const intervenants = [...new Set(interventions.map(i => i.fullName))].filter(Boolean);
            const days = [...new Set(interventions.map(i => i.dayOfWeek))].filter(Boolean);

            // Remplir le filtre des types de culte
            const cultTypeSelect = document.getElementById('filter-cult-type');
            if (cultTypeSelect) {
                cultTypeSelect.innerHTML = '<option value="">Tous les types</option>';
                cultTypes.forEach(type => {
                    cultTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
                });
            }

            // Remplir le filtre des lieux
            const placeSelect = document.getElementById('filter-place');
            if (placeSelect) {
                placeSelect.innerHTML = '<option value="">Tous les lieux</option>';
                places.forEach(place => {
                    placeSelect.innerHTML += `<option value="${place}">${place}</option>`;
                });
            }

            // Remplir le filtre des intervenants
            const intervenantSelect = document.getElementById('filter-intervenant');
            if (intervenantSelect) {
                intervenantSelect.innerHTML = '<option value="">Tous les intervenants</option>';
                intervenants.forEach(name => {
                    intervenantSelect.innerHTML += `<option value="${name}">${name}</option>`;
                });
            }

            // Remplir le filtre des jours
            const daySelect = document.getElementById('filter-day');
            if (daySelect) {
                daySelect.innerHTML = '<option value="">Tous les jours</option>';
                days.forEach(day => {
                    daySelect.innerHTML += `<option value="${day}">${day}</option>`;
                });
            }
        }

        // Fonction pour afficher les interventions
        function displayInterventions(interventionsToShow) {
            const tableBody = document.getElementById('interventions-table-body');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            interventionsToShow.forEach(intervention => {
                const intervenant = intervenantsDB.find(iv =>
                    iv.firstName === intervention.firstName && iv.lastName === intervention.lastName
                );

                const category = intervenant ? intervenant.category : 'inconnue';

                const categoryLabels = {
                    'clergy': 'Clergé',
                    'members': 'Membres',
                    'singers': 'Chanteurs',
                    'musicians': 'Musiciens',
                    'technical': 'Technique',
                    'volunteers': 'Bénévoles'
                };

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(intervention.date)}</td>
                    <td>${intervention.dayOfWeek}</td>
                    <td>${intervention.cultType}</td>
                    <td>${intervention.place}</td>
                    <td>${intervention.theme || ''}</td>
                    <td>${intervention.fullName}</td>
                    <td>${categoryLabels[category] || 'Inconnue'}</td>
                    <td>${intervention.observations || ''}</td>
                `;
                tableBody.appendChild(row);
            });

            // Mettre à jour le compteur de résultats
            const resultsCount = document.getElementById('results-count');
            if (resultsCount) {
                resultsCount.textContent = `${interventionsToShow.length} intervention(s)`;
            }
        }

        // Fonction pour formater la date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Fonction pour configurer les événements
        function setupRapportEventListeners() {
            // Événements pour les filtres
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }

            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', clearFilters);
            }

            const exportPdfBtn = document.getElementById('export-pdf-btn');
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', showPdfCustomizationModal);
            }

            // Bouton de publication
            const publishBtn = document.getElementById('publish-btn');
            if (publishBtn) {
                publishBtn.addEventListener('click', publishData);
            }

            // Événements pour la personnalisation PDF
            const confirmPdfExport = document.getElementById('confirm-pdf-export');
            if (confirmPdfExport) {
                confirmPdfExport.addEventListener('click', function() {
                    const options = {
                        orientation: document.getElementById('pdf-orientation').value,
                        format: document.getElementById('pdf-format').value,
                        margins: {
                            top: parseInt(document.getElementById('pdf-margin-top').value) || 10,
                            right: parseInt(document.getElementById('pdf-margin-right').value) || 10,
                            bottom: parseInt(document.getElementById('pdf-margin-bottom').value) || 10,
                            left: parseInt(document.getElementById('pdf-margin-left').value) || 10
                        },
                        includeLogo: document.getElementById('pdf-include-logo').checked
                    };

                    const fileName = document.getElementById('pdf-filename').value || 'Rapport_Interventions';

                    // Fermer la modale
                    const modal = bootstrap.Modal.getInstance(document.getElementById('pdfCustomizationModal'));
                    if (modal) {
                        modal.hide();
                    }

                    // Générer le PDF
                    generatePDFReportWrapper(options, fileName);
                });
            }
        }

        // Fonction pour appliquer les filtres
        function applyFilters() {
            const startDate = document.getElementById('filter-date-start').value;
            const endDate = document.getElementById('filter-date-end').value;
            const cultType = document.getElementById('filter-cult-type').value;
            const place = document.getElementById('filter-place').value;
            const intervenant = document.getElementById('filter-intervenant').value;
            const category = document.getElementById('filter-category').value;
            const day = document.getElementById('filter-day').value;

            let filteredInterventions = [...interventions];

            // Filtre par date de début
            if (startDate) {
                filteredInterventions = filteredInterventions.filter(i => i.date >= startDate);
            }

            // Filtre par date de fin
            if (endDate) {
                filteredInterventions = filteredInterventions.filter(i => i.date <= endDate);
            }

            // Filtre par type de culte
            if (cultType) {
                filteredInterventions = filteredInterventions.filter(i => i.cultType === cultType);
            }

            // Filtre par lieu
            if (place) {
                filteredInterventions = filteredInterventions.filter(i => i.place === place);
            }

            // Filtre par intervenant
            if (intervenant) {
                filteredInterventions = filteredInterventions.filter(i => i.fullName === intervenant);
            }

            // Filtre par catégorie
            if (category) {
                filteredInterventions = filteredInterventions.filter(i => {
                    const intervenant = intervenantsDB.find(iv =>
                        iv.firstName === i.firstName && iv.lastName === i.lastName
                    );
                    return intervenant && intervenant.category === category;
                });
            }

            // Filtre par jour
            if (day) {
                filteredInterventions = filteredInterventions.filter(i => i.dayOfWeek === day);
            }

            // Afficher les interventions filtrées
            displayInterventions(filteredInterventions);
        }

        // Fonction pour effacer les filtres
        function clearFilters() {
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-cult-type').value = '';
            document.getElementById('filter-place').value = '';
            document.getElementById('filter-intervenant').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-day').value = '';

            displayInterventions(interventions);
        }

        // Fonction pour afficher les alertes
        function showAlert(message, type = 'info') {
            // Supprimer les alertes existantes
            const existingAlert = document.querySelector('.alert-custom');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-custom`;
            alertDiv.textContent = message;

            document.body.appendChild(alertDiv);

            // Supprimer l'alerte après 5 secondes
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Fonction pour changer de thème
        function changeTheme(theme) {
            // Valider que le thème est autorisé pour éviter les injections CSS
            const allowedThemes = ['light', 'dark', 'neon', 'galaxy', 'rainbow', 'high-contrast', 'pastel'];
            if (!allowedThemes.includes(theme)) {
                console.warn(`Thème non autorisé : ${theme}`);
                return;
            }

            document.body.className = 'theme-' + theme;
        }

        function generatePDFReportWrapper(options, fileName) {
            // Récupérer les interventions filtrées actuelles
            const tableRows = document.querySelectorAll('#interventions-table-body tr');
            if (tableRows.length === 0) {
                showAlert('Aucune intervention à exporter.', 'warning');
                return;
            }

            // Générer un tableau des interventions à partir des lignes du tableau affiché
            const interventionsToShow = [];
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) { // S'assurer qu'il y a suffisamment de cellules
                    const intervention = {
                        date: reverseDateFormat(cells[0].textContent.trim()),
                        dayOfWeek: cells[1].textContent.trim(),
                        cultType: cells[2].textContent.trim(),
                        place: cells[3].textContent.trim(),
                        theme: cells[4].textContent.trim(),
                        fullName: cells[5].textContent.trim(),
                        firstName: '', // Ces champs seront extraits de fullName si possible
                        lastName: '',
                        observations: cells[7].textContent.trim()
                    };

                    // Extraire prénom et nom de la chaîne complète
                    const nameParts = intervention.fullName.split(' ');
                    if (nameParts.length >= 2) {
                        intervention.firstName = nameParts[0];
                        intervention.lastName = nameParts.slice(1).join(' ');
                    } else {
                        intervention.firstName = intervention.fullName;
                    }

                    interventionsToShow.push(intervention);
                }
            });

            // Appeler la fonction de génération PDF
            generatePDFReport(interventionsToShow, options, fileName);
        }

        // Fonction utilitaire pour inverser le format de date (de dd/mm/yyyy à yyyy-mm-dd)
        function reverseDateFormat(dateStr) {
            if (!dateStr || dateStr.length !== 10) return dateStr; // Si le format n'est pas dd/mm/yyyy, retourner tel quel
            const parts = dateStr.split('/');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        // Fonction pour générer un PDF spécifique pour la page de rapport
        async function generatePDFReport(interventionsToShow, options = {}, fileName = 'Rapport_Interventions') {
            if (interventionsToShow.length === 0) {
                showAlert('Aucune intervention à exporter.', 'warning');
                return null;
            }

            try {
                // Initialisation robuste de jsPDF
                let jsPDF;
                if (window.jspdf && window.jspdf.jsPDF) {
                    jsPDF = window.jspdf.jsPDF;
                } else if (window.jsPDF) {
                    jsPDF = window.jsPDF;
                } else {
                    throw new Error("La bibliothèque jsPDF n'est pas chargée correctement.");
                }

                // Utiliser les options de personnalisation ou les valeurs par défaut
                const orientation = options.orientation || 'portrait';
                const format = options.format || 'a4';
                const margins = options.margins || { top: 10, right: 10, bottom: 10, left: 10 };
                const includeLogo = options.hasOwnProperty('includeLogo') ? options.includeLogo : true;

                // Créer le document PDF
                const doc = new jsPDF(orientation, 'mm', format);

                // Dimensions de la page
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;

                // Position de départ
                let yPosition = margins.top;

                // Ajouter le logo si demandé
                if (includeLogo) {
                    try {
                        const logo = new Image();
                        logo.src = 'AD.jpeg';

                        // Attendre le chargement de l'image
                        await new Promise((resolve, reject) => {
                            logo.onload = resolve;
                            logo.onerror = reject;
                        });

                        // Calculer les dimensions du logo (max 30mm de hauteur)
                        const logoMaxHeight = 30;
                        const logoMaxWidth = 30;
                        let logoWidth = logo.width * (logoMaxHeight / logo.height);
                        let logoHeight = logoMaxHeight;

                        if (logoWidth > logoMaxWidth) {
                            logoWidth = logoMaxWidth;
                            logoHeight = logo.height * (logoMaxWidth / logo.width);
                        }

                        // Positionner le logo en haut à gauche
                        doc.addImage(logo, 'JPEG', margins.left, yPosition, logoWidth, logoHeight);

                        // Mettre à jour la position verticale
                        yPosition += Math.max(logoHeight, 20) + 5;
                    } catch (error) {
                        console.warn("Impossible de charger le logo:", error);
                        // Continuer sans le logo
                        yPosition += 10;
                    }
                }

                // Ajouter le titre
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text("RAPPORT DÉTAILLÉ DES INTERVENTIONS", pageWidth / 2, yPosition, { align: 'center' });

                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                yPosition += 8;
                doc.text("Assemblées de Dieu du Bénin - Église BERACA", pageWidth / 2, yPosition, { align: 'center' });

                // Ajouter la date de génération
                yPosition += 8;
                doc.setFontSize(10);
                doc.text(`Généré le: ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, pageWidth / 2, yPosition, { align: 'center' });

                yPosition += 12;

                // Générer le tableau des interventions
                const tableData = interventionsToShow.map((intervention, index) => {
                    // Trouver les informations de l'intervenant
                    const intervenant = intervenantsDB.find(i =>
                        i.firstName === intervention.firstName && i.lastName === intervention.lastName
                    );

                    const categoryLabels = {
                        'clergy': 'Clergé',
                        'members': 'Membres',
                        'singers': 'Chanteurs',
                        'musicians': 'Musiciens',
                        'technical': 'Technique',
                        'volunteers': 'Bénévoles'
                    };

                    const category = intervenant ? categoryLabels[intervenant.category] || intervenant.category : 'Inconnue';

                    return [
                        (index + 1).toString(),
                        formatDateForDisplay(intervention.date),
                        intervention.dayOfWeek,
                        intervention.cultType,
                        intervention.place,
                        intervention.theme,
                        intervention.fullName,
                        category,
                        intervention.observations || ''
                    ];
                });

                // En-têtes du tableau
                const headers = [
                    "#",
                    "Date",
                    "Jour",
                    "Type de culte",
                    "Lieu",
                    "Thème",
                    "Intervenant",
                    "Catégorie",
                    "Observations"
                ];

                // Vérifier si jspdf-autotable est disponible
                if (typeof doc.autoTable !== 'function') {
                    throw new Error("jspdf-autotable n'est pas chargé correctement.");
                }

                // Ajouter le tableau
                doc.autoTable({
                    head: [headers],
                    body: tableData,
                    startY: yPosition,
                    margin: { top: margins.top, right: margins.right, bottom: margins.bottom, left: margins.left },
                    styles: {
                        fontSize: 8,
                        cellPadding: 3
                    },
                    headStyles: {
                        fillColor: [41, 128, 185],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        textColor: [0, 0, 0]
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    },
                    columnStyles: {
                        0: { cellWidth: 10 }, // Numéro
                        1: { cellWidth: 25 }, // Date
                        2: { cellWidth: 20 }, // Jour
                        3: { cellWidth: 30 }, // Type de culte
                        4: { cellWidth: 25 }, // Lieu
                        5: { cellWidth: 35 }, // Thème
                        6: { cellWidth: 40 }, // Intervenant
                        7: { cellWidth: 25 }, // Catégorie
                        8: { cellWidth: 35 }  // Observations
                    },
                    didDrawPage: function(data) {
                        // Ajouter les numéros de page
                        const pageCount = doc.getNumberOfPages();
                        doc.setFontSize(10);
                        const pageText = `Page ${data.pageNumber} sur ${pageCount}`;
                        doc.text(pageText, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    }
                });

                // Sauvegarder le PDF
                doc.save(`${fileName}.pdf`);

                // Afficher une alerte de succès
                showAlert(`PDF "${fileName}.pdf" généré avec succès!`, 'success');

                return doc;
            } catch (error) {
                console.error("Erreur lors de la génération du PDF:", error);
                showAlert(`Erreur lors de la génération du PDF: ${error.message}`, 'danger');
                return null;
            }
        }

        // Fonction pour formater la date pour l'affichage
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Fonction pour afficher la modale de personnalisation PDF
        function showPdfCustomizationModal() {
            // Pré-remplir le nom du fichier
            const defaultName = `Rapport_Interventions_${new Date().toISOString().slice(0, 10)}`;
            document.getElementById('pdf-filename').value = defaultName;

            // Ouvrir la modale
            const modal = new bootstrap.Modal(document.getElementById('pdfCustomizationModal'));
            modal.show();
        }


        // Fonction pour publier les données
        function publishData() {
            // Vérifier s'il y a des interventions à publier
            if (interventions.length === 0) {
                showAlert('Veuillez créer au moins une intervention avant de publier.', 'warning');
                return;
            }

            // Récupérer toutes les données nécessaires
            const dataToPublish = {
                interventions: interventions,
                intervenantsDB: intervenantsDB,
                generalInfo: {
                    churchName: 'EGLISE EVANGELIQUE DES ASSEMBLEES DE DIEU DU BENIN', // Valeurs par défaut
                    region: 'ATACORA',
                    section: 'NATITINGOU',
                    temple: 'BERACA',
                    year: '2025',
                    quarter: '4'
                },
                configurations: {
                    days: [],
                    types: [],
                    places: [],
                    otherType: '',
                    otherPlace: ''
                },
                theme: document.body.className.replace('theme-', ''),
                publishedAt: new Date().toISOString()
            };

            // Récupérer les configurations cochées (pour les besoins de la publication)
            document.querySelectorAll('input[id^="day-"]:checked').forEach(checkbox => {
                dataToPublish.configurations.days.push(checkbox.value);
            });

            document.querySelectorAll('input[id^="type-"]:checked').forEach(checkbox => {
                dataToPublish.configurations.types.push(checkbox.value);
            });

            document.querySelectorAll('input[id^="place-"]:checked').forEach(checkbox => {
                dataToPublish.configurations.places.push(checkbox.value);
            });

            try {
                // Convertir les données en chaîne JSON
                const dataStr = JSON.stringify(dataToPublish);

                // Encoder les données pour l'URL (compression et encodage sécurisé)
                const encodedData = btoa(encodeURIComponent(dataStr).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));

                // Générer l'URL de partage
                const currentUrl = window.location.href.split('?')[0]; // Retirer les paramètres existants
                const publishUrl = `${currentUrl}?data=${encodedData}`;

                // Afficher une modale avec le lien de partage
                showPublishModal(publishUrl);

                // Ajouter les données au stockage local sans date d'expiration
                const storageKey = `published_data_${Date.now()}`;
                const storedData = {
                    data: dataToPublish,
                    createdAt: new Date().toISOString(),
                    isPermanent: true // Indique que cette publication est permanente
                };

                localStorage.setItem(storageKey, JSON.stringify(storedData));

                // Sauvegarder la clé dans une liste pour gestion future
                let publishedKeys = JSON.parse(localStorage.getItem('published_keys') || '[]');
                publishedKeys.push({
                    key: storageKey,
                    url: publishUrl,
                    createdAt: new Date().toISOString(),
                    isPermanent: true
                });
                localStorage.setItem('published_keys', JSON.stringify(publishedKeys));

                showAlert('Données publiées avec succès !', 'success');
            } catch (error) {
                console.error('Erreur lors de la publication:', error);
                showAlert('Erreur lors de la publication des données: ' + error.message, 'danger');
            }
        }

        // Fonction pour afficher la modale de publication
        function showPublishModal(publishUrl) {
            // Créer la modale si elle n'existe pas
            let modal = document.getElementById('publishModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'publishModal';
                modal.className = 'modal fade';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-share-alt me-2"></i>Publication des Données</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Voici le lien pour accéder à ces données publiées :</p>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="publish-link" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="copy-link-btn">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Ce lien permet d'accéder aux données planifiées.
                                    Les données sont stockées localement et accessibles via ce lien.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Mettre à jour le lien dans la modale
            document.getElementById('publish-link').value = publishUrl;

            // Configurer le bouton de copie
            document.getElementById('copy-link-btn').onclick = function() {
                const linkInput = document.getElementById('publish-link');
                linkInput.select();
                document.execCommand('copy');
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check"></i> Copié!';
                setTimeout(() => {
                    this.innerHTML = originalText;
                }, 2000);
                showAlert('Lien copié dans le presse-papiers', 'success');
            };

            // Afficher la modale
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }
    </script>
</body>
</html>