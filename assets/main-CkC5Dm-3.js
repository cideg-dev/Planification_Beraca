(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();const h={SUPABASE_URL:"https://supywgkoghcphlynktmr.supabase.co",SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1cHl3Z2tvZ2hjcGhseW5rdG1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NTYzNjQsImV4cCI6MjA4MjQzMjM2NH0.b_6COwOKkt2sWOuzM42W-LZfraPJJSKXhax69IUGwWc",ADMIN_CODE:"Sarah2017"},I={DAYS_OF_WEEK:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],CULT_TYPES_BY_DAY:{Dimanche:["Principal","Enseignement","Culte des enfants","Culte des Adolescents"],Lundi:["R√©union"],Mardi:["Pri√®re hebdomadaire","Enseignement"],Mercredi:["Enseignement","R√©union","Culte des Adolescents"],Jeudi:["T√©moignage/Action de gr√¢ce/Pri√®re","R√©union"],Vendredi:["Enseignement","Veill√©e de pri√®re","R√©union"],Samedi:["Jeune et Pri√®re","Veill√©e de pri√®re","Culte des Adolescents"]}},k=window.supabase?window.supabase.createClient:null;k||console.error("Critical Error: Supabase library not loaded. Check CDN script in index.html.");let H=null;const j=t=>{try{return t&&t.startsWith("http")}catch{return!1}};if(k&&j(h.SUPABASE_URL)&&h.SUPABASE_ANON_KEY&&!h.SUPABASE_ANON_KEY.startsWith("___"))try{H=k(h.SUPABASE_URL,h.SUPABASE_ANON_KEY)}catch(t){console.error("Supabase initialization error:",t)}else console.warn("Supabase non initialis√© : URL invalide ou Cl√© manquante.");const p=H;async function F(){if(!p)return console.error("Supabase client not initialized"),!1;try{const{data:t,error:e}=await p.from("interventions").select("*").limit(1);return e?(console.error("Connection test error:",e),!1):(console.log("Supabase connection successful:",t),!0)}catch(t){return console.error("Connection test error:",t),!1}}const g={async getIntervenants(){if(!p)return[];try{const{data:t,error:e}=await p.from("intervenants").select("*").order("lastname");if(e)throw e;return t||[]}catch(t){return console.error(t),[]}},async getInterventions(){if(!p)return[];try{const{data:t,error:e}=await p.from("interventions").select("*").order("date",{ascending:!0});if(e)throw e;return t||[]}catch(t){return console.error(t),[]}},async addIntervention(t){if(!p)throw new Error("Client non initialis√©");const{data:e,error:n}=await p.from("interventions").insert([t]).select();if(n)throw n;return e[0]},async updateIntervention(t,e){if(!p)throw new Error("Client non initialis√©");const{data:n,error:s}=await p.from("interventions").update(e).eq("id",t).select();if(s)throw s;return n[0]},async deleteIntervention(t){if(!p)throw new Error("Client non initialis√©");const{error:e}=await p.from("interventions").delete().eq("id",t);if(e)throw e;return!0},async addIntervenant(t){if(!p)throw new Error("Client non initialis√©");const{data:e,error:n}=await p.from("intervenants").insert([t]).select();if(n)throw n;return e[0]},async getConfig(){if(!p)return null;try{const{data:t,error:e}=await p.from("configurations").select("*").limit(1);if(e)throw e;return t[0]||null}catch(t){return console.error(t),null}},async updateConfig(t){if(!p)return null;try{const e=await this.getConfig();let n;return e?n=await p.from("configurations").update(t).eq("id",e.id).select():n=await p.from("configurations").insert([t]).select(),n.data[0]}catch(e){return console.error(e),null}}},O=t=>new Promise((e,n)=>{const s=new Image;s.crossOrigin="Anonymous",s.onload=()=>{const a=document.createElement("canvas");a.width=s.width,a.height=s.height,a.getContext("2d").drawImage(s,0,0),e(a.toDataURL("image/jpeg"))},s.onerror=a=>{console.warn("Erreur chargement logo, PDF sans logo",a),e(null)},s.src=t}),x={exportToExcel(t,e={}){const n=t.map(i=>({Date:new Date(i.date).toLocaleDateString("fr-FR"),Jour:i.day,Type:i.type,Lieu:i.place,"Th√®me/Desc":i.description||"",Intervenant:i.intervenantStr||i.intervenant?.last_name||"Non assign√©"})),s=XLSX.utils.json_to_sheet([]);XLSX.utils.sheet_add_aoa(s,[["ASSEMBL√âES DE DIEU DU B√âNIN"],[`√âglise: ${e.church||"AD BERACA"}`],[`R√©gion: ${e.region||""} | Section: ${e.section||""}`],[`Planning: ${e.year||""} - Trimestre ${e.quarter||""}`],[""]],{origin:"A1"}),XLSX.utils.sheet_add_json(s,n,{origin:"A6",skipHeader:!1});const a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,s,"Planning"),XLSX.writeFile(a,`Planning_AD_${e.church||"Beraca"}_${new Date().toISOString().slice(0,10)}.xlsx`)},async exportToPdf(t,e={}){const n=new jsPDF,s=e.logo&&e.logo.trim()!==""?e.logo:"AD.jpeg",a=await O(s);n.setFont("times","normal");const i=n.internal.pageSize.getWidth(),r=n.internal.pageSize.getHeight();let l=20;a&&n.addImage(a,"JPEG",14,10,20,20),n.setFontSize(18),n.setTextColor(44,62,80),n.text("ASSEMBL√âES DE DIEU DU B√âNIN",i/2,l,{align:"center"}),l+=8,n.setFontSize(14),n.setFont("times","bold"),n.text(`√âGLISE : ${e.church||"AD BERACA"}`,i/2,l,{align:"center"}),l+=7,n.setFontSize(11),n.setFont("times","normal"),n.setTextColor(100),n.text(`R√©gion: ${e.region||"ATACORA"} | Section: ${e.section||"NATITINGOU"}`,i/2,l,{align:"center"}),l+=5;let c="";e.phone&&(c+=`T√©l: ${e.phone} `),e.email&&(c+=`| Email: ${e.email}`),c&&(n.setFontSize(9),n.text(c.trim().replace(/^\| /,""),i/2,l,{align:"center"}),l+=5),n.setFontSize(11),n.setTextColor(44,62,80),n.text(`Planning Ann√©e: ${e.year||"2026"} - Trimestre: ${e.quarter||"1"}`,i/2,l,{align:"center"}),l+=5,n.setLineWidth(.5),n.setDrawColor(200),n.line(14,l,i-14,l);const d=["Date","Jour","Type","Lieu","Intervenant","D√©tails"],f=[];t.forEach(m=>{const v=[new Date(m.date).toLocaleDateString("fr-FR"),m.day,m.type,m.place,m.intervenantStr||(m.intervenant?`${m.intervenant.first_name} ${m.intervenant.last_name}`:""),m.description||""];f.push(v)}),autoTable(n,{head:[d],body:f,startY:l+10,theme:"grid",styles:{font:"times",fontSize:10,cellPadding:3,valign:"middle",lineWidth:.1,lineColor:[200,200,200]},headStyles:{fillColor:[240,240,240],textColor:[44,62,80],fontStyle:"bold",lineWidth:.1,lineColor:[100,100,100]},columnStyles:{0:{cellWidth:22},1:{cellWidth:22},2:{cellWidth:25},3:{cellWidth:25},4:{cellWidth:40,fontStyle:"bold"},5:{cellWidth:"auto"}},didDrawPage:function(m){e.bank&&(n.setFontSize(9),n.setTextColor(44,62,80),n.text(`Donn√©es Bancaires: ${e.bank}`,14,r-15)),n.setFontSize(8),n.setTextColor(150),n.text(`G√©n√©r√© le ${new Date().toLocaleDateString("fr-FR")} - Page ${n.internal.getNumberOfPages()}`,i-20,r-10,{align:"right"})}}),n.save(`Planning_AD_${e.church||"Beraca"}_${new Date().toISOString().slice(0,10)}.pdf`)}},z={async getSuggestions(t,e){console.log(`üß† Analyse IA pour : ${e} le ${t}`);const[n,s]=await Promise.all([g.getIntervenants(),g.getInterventions()]),a=q(e);return n.map(r=>{if(s.some(m=>m.date===t&&(m.intervenantId===r.id||m.intervenantStr===r.last_name)))return null;let c=100;const d=[],f=s.filter(m=>m.intervenantId===r.id).sort((m,v)=>new Date(v.date)-new Date(m.date));if(f.length>0){const m=f[0],v=(new Date(t)-new Date(m.date))/(1e3*60*60*24);v<7?(c-=50,d.push("üî¥ A parl√© tr√®s r√©cemment")):v>30?(c+=20,d.push(`üü¢ Dispo depuis ${Math.floor(v)} jours`)):d.push(`A parl√© il y a ${Math.floor(v)} jours`)}else c+=30,d.push("‚ú® Jamais intervenu");return a.includes(r.category)&&(c+=15,d.push("‚≠ê Profil adapt√© au type")),e.includes("Principal")&&(r.title==="Pasteur"||r.title==="Diacre")&&(c+=10),{...r,score:c,reasons:d}}).filter(r=>r!==null).sort((r,l)=>l.score-r.score).slice(0,5)}};function q(t){const e=t.toLowerCase();return e.includes("enseignement")||e.includes("principal")||e.includes("sainte c√®ne")?["clergy"]:e.includes("louange")?["singers","musicians"]:["clergy","members"]}const V={calculateStats(t){if(!t||t.length===0)return null;const e=t.length,n={};t.forEach(d=>{n[d.type]=(n[d.type]||0)+1});const s={};t.forEach(d=>{const f=d.intervenantStr||d.intervenant?.last_name||"Inconnu";s[f]=(s[f]||0)+1});const a=Object.entries(s).sort((d,f)=>f[1]-d[1]).slice(0,5),i=["Jan","F√©v","Mar","Avr","Mai","Juin","Juil","Ao√ªt","Sep","Oct","Nov","D√©c"],r=new Array(12).fill(0);t.forEach(d=>{const f=new Date(d.date);isNaN(f)||r[f.getMonth()]++});const l={};let c={name:"-",count:0};return t.forEach(d=>{l[d.place]=(l[d.place]||0)+1,l[d.place]>c.count&&(c={name:d.place,count:l[d.place]})}),{kpi:{total:e,topSpeaker:a[0]?a[0][0]:"-",topPlace:c.name},charts:{types:{labels:Object.keys(n),data:Object.values(n)},speakers:{labels:a.map(d=>d[0]),data:a.map(d=>d[1])},timeline:{labels:i,data:r}}}}},S={async requestPermission(){return"Notification"in window?await Notification.requestPermission()==="granted"?(console.log("Permission accord√©e pour les notifications"),!0):!1:(console.log("Ce navigateur ne supporte pas les notifications bureau"),!1)},async getNotifications(t){if(!p||!t)return[];const{data:e,error:n}=await p.from("notifications").select("*").eq("user_id",t).order("created_at",{ascending:!1}).limit(20);return n?(console.error("Erreur r√©cup notifications:",n),[]):e},async markAsRead(t){const{error:e}=await p.from("notifications").update({is_read:!0}).eq("id",t);return!e},async markAllAsRead(t){const{error:e}=await p.from("notifications").update({is_read:!0}).eq("user_id",t).eq("is_read",!1);return!e}},U=window.bootstrap.Alert,u={showAlert(t,e="info"){const n=document.getElementById("alert-placeholder");if(!n)return;const s=document.createElement("div");s.innerHTML=[`<div class="alert alert-${e} alert-dismissible fade show" role="alert">`,`   <div>${t}</div>`,'   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',"</div>"].join(""),n.append(s),setTimeout(()=>{const a=s.querySelector(".alert");if(a){const i=U.getOrCreateInstance(a);i&&i.close()}},5e3)},toggleLoading(t){let e=document.getElementById("global-loader");!e&&t&&(e=document.createElement("div"),e.id="global-loader",e.style.cssText=`
                position: fixed;
                top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex; justify-content: center; align-items: center;
                z-index: 9999;
            `,e.innerHTML='<div class="spinner-border text-light" role="status"><span class="visually-hidden">Chargement...</span></div>',document.body.appendChild(e)),e&&(e.style.display=t?"flex":"none")},updateSyncStatus(t){const e={loading:"fas fa-sync-alt fa-spin",synced:"fas fa-check-circle text-success",error:"fas fa-exclamation-triangle text-danger",saved:"fas fa-save text-primary"},n={loading:"Chargement...",synced:"Synchronis√©",error:"Erreur",saved:"Sauvegard√©"},s=document.getElementById("sync-indicator");s&&(s.innerHTML=`<i class="${e[t]||""}"></i> <span class="d-none d-md-inline">${n[t]||""}</span>`)}},b=window.bootstrap.Modal,y=window.Chart;function R(t){let e=0;for(let n=0;n<t.length;n++){const s=t.charCodeAt(n);e=(e<<5)-e+s,e|=0}return e}const o={interventions:[],intervenants:[],config:{church:"AD BERACA",region:"ATACORA",section:"NATITINGOU",year:new Date().getFullYear(),quarter:Math.floor((new Date().getMonth()+3)/3),phone:"",email:"",bank:"",logo:"AD.jpeg"},searchQuery:"",currentDate:new Date().toISOString().split("T")[0],charts:{},passwordHash:1234567890,isAuthenticated:!1};function W(){const t="Martial1989";o.passwordHash=R(t)}function D(t,e="info",n=!0){u.showAlert(t,e),n&&J()}function J(){const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),n=t.createGain();e.connect(n),n.connect(t.destination),e.type="sine",e.frequency.value=800,n.gain.value=.3,e.start(),n.gain.exponentialRampToValueAtTime(1e-5,t.currentTime+.5),setTimeout(()=>{e.stop()},500)}function Y(t,e){const n={added:[],updated:[],deleted:[]},s=new Map(t.map(i=>[i.id,i])),a=new Map(e.map(i=>[i.id,i]));for(const[i,r]of s)a.has(i)||n.deleted.push(r);for(const[i,r]of a){const l=s.get(i);l?JSON.stringify(l)!==JSON.stringify(r)&&n.updated.push({old:l,new:r}):n.added.push(r)}return n}function X(t){const e=[];if(t.added.length>0){const n=t.added.length;e.push(`${n} nouvelle${n>1?"s":""} planification${n>1?"s":""} ajout√©e${n>1?"s":""}`)}if(t.updated.length>0){const n=t.updated.length;e.push(`${n} planification${n>1?"s":""} modifi√©e${n>1?"s":""}`)}if(t.deleted.length>0){const n=t.deleted.length;e.push(`${n} planification${n>1?"s":""} supprim√©e${n>1?"s":""}`)}return e.join(", ")}async function G(){try{const t=[...o.interventions],e=await g.getInterventions();o.interventions=e;const n=Y(t,e);if(n.added.length>0||n.updated.length>0||n.deleted.length>0){const s=X(n);D(s,"info",!0),M()}}catch(t){console.error("Erreur lors de la v√©rification des modifications:",t)}}function K(){setInterval(G,3e4)}function Q(){K(),o.initialInterventions=[...o.interventions]}W();async function Z(){te(),await F()||u.showAlert("Erreur de connexion √† la base de donn√©es. Veuillez v√©rifier la configuration des secrets sur GitHub.","danger"),ue(),ae(),be(),Le(),await A(),ee(),Q()}document.addEventListener("DOMContentLoaded",Z);"serviceWorker"in navigator&&window.addEventListener("load",()=>console.log("PWA Ready"));async function ee(){const t=document.getElementById("btn-notifications");document.getElementById("notifications-list"),document.getElementById("notification-badge");const e=document.getElementById("btn-mark-all-read");t&&(await B(),t.addEventListener("click",async()=>{Notification.permission==="default"&&await S.requestPermission()&&console.log("Web Push activ√© pour cet utilisateur")}),e?.addEventListener("click",async n=>{n.stopPropagation(),await S.markAllAsRead("00000000-0000-0000-0000-000000000000"),await B()}))}async function B(){const t=document.getElementById("notifications-list"),e=document.getElementById("notification-badge"),n=await S.getNotifications("00000000-0000-0000-0000-000000000000"),s=n.filter(a=>!a.is_read).length;if(s>0?(e.textContent=s,e.style.display="block"):e.style.display="none",n.length===0){t.innerHTML='<div class="text-center py-3 text-muted small">Aucune notification</div>';return}t.innerHTML=n.map(a=>`
        <button class="list-group-item list-group-item-action p-2 border-start-0 border-end-0 ${a.is_read?"":"bg-light fw-bold"}" 
                onclick="markNotificationRead('${a.id}')">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small text-primary">${a.type}</span>
                <span class="text-muted" style="font-size: 0.7rem;">${new Date(a.created_at).toLocaleDateString()}</span>
            </div>
            <p class="mb-0 small text-truncate">${a.title}</p>
            <p class="mb-0 text-muted" style="font-size: 0.75rem;">${a.message}</p>
        </button>
    `).join("")}window.markNotificationRead=async t=>{await S.markAsRead(t),await B()};window.testNotif=async()=>{console.log("Envoi d'une notification de test...");const t={user_id:"00000000-0000-0000-0000-000000000000",title:"Rappel de culte",message:"N'oubliez pas le culte de ce soir √† 19h.",type:"reminder",channel:"in_app",is_read:!1};try{const{error:e}=await supabaseClient.from("notifications").insert([t]);if(e){console.warn("Table 'notifications' non trouv√©e ou erreur RLS. Mode simulation activ√©.",e);const n=document.getElementById("notifications-list"),s=document.getElementById("notification-badge");s.style.display="block",s.textContent=parseInt(s.textContent||"0")+1;const a=`
            <button class="list-group-item list-group-item-action p-2 border-start-0 border-end-0 bg-light fw-bold">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small text-primary">Test</span>
                    <span class="text-muted" style="font-size: 0.7rem;">√Ä l'instant</span>
                </div>
                <p class="mb-0 small text-truncate">${t.title}</p>
                <p class="mb-0 text-muted" style="font-size: 0.75rem;">${t.message}</p>
            </button>`;n.innerHTML.includes("Aucune notification")?n.innerHTML=a:n.insertAdjacentHTML("afterbegin",a)}else console.log("Notification ins√©r√©e dans Supabase !"),await B()}catch(e){console.error(e)}};function te(){const t=localStorage.getItem("app-theme"),e=window.matchMedia("(prefers-color-scheme: dark)").matches;t==="dark"||!t&&e?(document.documentElement.setAttribute("data-theme","dark"),$("dark")):(document.documentElement.setAttribute("data-theme","light"),$("light"))}function ne(){const e=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("app-theme",e),$(e)}function $(t){const e=document.getElementById("theme-toggle");if(!e)return;const n=e.querySelector("i");n&&(n.className=t==="dark"?"fas fa-sun":"fas fa-moon",e.title=t==="dark"?"Passer en mode clair":"Passer en mode sombre")}function ae(){const t=document.querySelectorAll("#main-nav button[data-view]");t.forEach(e=>{e.addEventListener("click",async n=>{const s=n.currentTarget.dataset.view;if(s==="settings-view"&&!o.isAuthenticated){if(!await se())return;o.isAuthenticated=!0}t.forEach(a=>{a.classList.remove("active","opacity-100"),a.classList.add("opacity-75")}),n.currentTarget.classList.add("active","opacity-100"),n.currentTarget.classList.remove("opacity-75"),document.querySelectorAll(".view-section").forEach(a=>{a.style.display="none"}),document.getElementById(s).style.display="block",s==="dashboard-view"&&de()})})}function se(){return new Promise(t=>{let e=document.getElementById("password-modal");e?_(e,t):(e=ie(),setTimeout(()=>{_(e,t)},0))})}function _(t,e){const n=t.querySelector("#password-input"),s=t.querySelector("#password-submit"),a=t.querySelector("#password-error");if(!n||!s||!a){console.error("√âl√©ments de la modale non trouv√©s"),e(!1);return}const i=new b(t);n.value="",a.style.display="none",n.classList.remove("is-invalid");const r=()=>{const c=n.value;R(c)===o.passwordHash?(i.hide(),e(!0)):(a.style.display="block",n.classList.add("is-invalid"),n.focus())};s.onclick=null,n.onkeypress=null,s.onclick=r,n.onkeypress=c=>{c.key==="Enter"&&r()};const l=()=>{t.removeEventListener("hidden.bs.modal",l),e(!1)};t.addEventListener("hidden.bs.modal",l),i.show(),n.focus()}function ie(){return document.body.insertAdjacentHTML("beforeend",`
        <div class="modal fade" id="password-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-primary text-white py-3">
                        <h5 class="modal-title fw-bold"><i class="fas fa-lock me-2"></i>Acc√®s restreint</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <p class="mb-3">Veuillez entrer le mot de passe pour acc√©der √† la page de configuration :</p>
                        <div class="mb-3">
                            <label for="password-input" class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="password-input" placeholder="Entrez le mot de passe">
                            <div id="password-error" class="text-danger mt-2" style="display: none;">
                                <i class="fas fa-exclamation-circle me-1"></i>Mot de passe incorrect
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light py-2">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary btn-sm" id="password-submit">Valider</button>
                    </div>
                </div>
            </div>
        </div>
    `),document.getElementById("password-modal")}async function re(t){const{date:e,recurrence:n,recurrence_end_date:s,...a}=t,i=s?new Date(s):new Date(e);i.setFullYear(i.getFullYear()+1);const r=new Date(e),l=[];let c=new Date(r);for(;c<=i;){const d={...a,date:c.toISOString().split("T")[0],day:I.DAYS_OF_WEEK[c.getDay()]};switch(l.push(d),n){case"daily":c.setDate(c.getDate()+1);break;case"weekly":c.setDate(c.getDate()+7);break;case"monthly":c.setMonth(c.getMonth()+1);break;case"yearly":c.setFullYear(c.getFullYear()+1);break;default:c.setDate(c.getDate()+1)}}for(const d of l)try{await g.addIntervention(d)}catch(f){console.error("Erreur lors de l'ajout de l'intervention r√©currente:",f)}u.showAlert(`${l.length} interventions r√©currentes cr√©√©es !`,"success")}async function oe(t,e){try{const n=await g.updateIntervenant(t,e),s=o.intervenants.findIndex(a=>a.id===t);return s!==-1&&(o.intervenants[s]=n),w(),u.showAlert("Intervenant mis √† jour avec succ√®s !","success"),n}catch(n){throw console.error("Erreur lors de la mise √† jour de l'intervenant:",n),u.showAlert("Erreur lors de la mise √† jour de l'intervenant","danger"),n}}function le(t){return new Promise(e=>{let n=document.getElementById("edit-intervenant-modal");n||(n=ce()),document.getElementById("edit-iv-title").value=t.title||"",document.getElementById("edit-iv-firstname").value=t.first_name||"",document.getElementById("edit-iv-lastname").value=t.last_name||"",document.getElementById("edit-iv-category").value=t.category||"members",n.dataset.intervenantId=t.id;const s=new b(n),a=async()=>{const l=n.querySelector("#edit-intervenant-submit"),c=l.innerHTML;l.innerHTML='<i class="fas fa-spinner fa-spin"></i>',l.disabled=!0;try{const d={title:document.getElementById("edit-iv-title").value,first_name:document.getElementById("edit-iv-firstname").value,last_name:document.getElementById("edit-iv-lastname").value,category:document.getElementById("edit-iv-category").value};await oe(t.id,d),s.hide(),e(!0)}catch{e(!1)}finally{l.innerHTML=c,l.disabled=!1}},i=n.querySelector("#edit-intervenant-submit");i.onclick=null,i.onclick=a;const r=n.querySelector(".modal-body form");r.onkeypress=l=>{l.key==="Enter"&&l.target.tagName!=="TEXTAREA"&&(l.preventDefault(),a())},n.addEventListener("hidden.bs.modal",()=>{e(!1)},{once:!0}),s.show()})}function ce(){return document.body.insertAdjacentHTML("beforeend",`
        <div class="modal fade" id="edit-intervenant-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-warning text-dark py-2">
                        <h6 class="modal-title small fw-bold"><i class="fas fa-user-edit me-2"></i>Modifier Intervenant</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-3">
                        <form id="form-edit-intervenant">
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">Titre</label>
                                <select class="form-select form-select-sm" id="edit-iv-title">
                                    <option value="">Aucun</option>
                                    <option value="Pasteur">Pasteur</option>
                                    <option value="Diacre">Diacre</option>
                                    <option value="Ancien">Ancien</option>
                                    <option value="Fr√®re">Fr√®re</option>
                                    <option value="S≈ìur">S≈ìur</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">Pr√©nom *</label>
                                <input type="text" class="form-control form-control-sm" id="edit-iv-firstname" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">Nom *</label>
                                <input type="text" class="form-control form-control-sm" id="edit-iv-lastname" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold mb-1">Cat√©gorie</label>
                                <select class="form-select form-select-sm" id="edit-iv-category">
                                    <option value="members">Membres</option>
                                    <option value="leaders">Dirigeants</option>
                                    <option value="deacons">Diacres</option>
                                    <option value="elders">Anciens</option>
                                    <option value="pastors">Pasteurs</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-warning btn-sm w-100" id="edit-intervenant-submit">
                                <i class="fas fa-save me-1"></i>Mettre √† jour
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `),document.getElementById("edit-intervenant-modal")}function de(){const t=V.calculateStats(o.interventions);t&&(document.getElementById("kpi-total").textContent=t.kpi.total,document.getElementById("kpi-speaker").textContent=t.kpi.topSpeaker,document.getElementById("kpi-place").textContent=t.kpi.topPlace,o.charts.timeline&&o.charts.timeline.destroy(),o.charts.types&&o.charts.types.destroy(),o.charts.speakers&&o.charts.speakers.destroy(),o.charts.timeline=new y(document.getElementById("chart-timeline"),{type:"line",data:{labels:t.charts.timeline.labels,datasets:[{label:"Interventions",data:t.charts.timeline.data,borderColor:"#0d6efd",tension:.4,fill:!0,backgroundColor:"rgba(13, 110, 253, 0.1)"}]},options:{responsive:!0,maintainAspectRatio:!1}}),o.charts.types=new y(document.getElementById("chart-types"),{type:"doughnut",data:{labels:t.charts.types.labels,datasets:[{data:t.charts.types.data,backgroundColor:["#0d6efd","#198754","#ffc107","#dc3545","#6c757d","#0dcaf0"]}]},options:{responsive:!0,plugins:{legend:{position:"bottom"}}}}),o.charts.speakers=new y(document.getElementById("chart-speakers"),{type:"bar",data:{labels:t.charts.speakers.labels,datasets:[{label:"Interventions",data:t.charts.speakers.data,backgroundColor:"#20c997",borderRadius:5}]},options:{responsive:!0,indexAxis:"y"}}))}function ue(){document.getElementById("main-form")?.addEventListener("submit",Ce),document.getElementById("btn-reset")?.addEventListener("click",()=>{document.getElementById("main-form").reset(),L(""),w()}),document.getElementById("btn-suggest-intervenant")?.addEventListener("click",Ae),document.getElementById("form-create-intervenant")?.addEventListener("submit",ke),document.getElementById("refresh-btn")?.addEventListener("click",A),document.getElementById("btn-save-settings")?.addEventListener("click",we),document.getElementById("export-excel-btn")?.addEventListener("click",()=>{const t=T();t.length?x.exportToExcel(t,o.config):u.showAlert("Rien √† exporter","warning")}),document.getElementById("export-pdf-btn")?.addEventListener("click",()=>{const t=T();t.length?x.exportToPdf(t,o.config):u.showAlert("Rien √† exporter","warning")}),document.getElementById("search-input")?.addEventListener("input",t=>{o.searchQuery=t.target.value.toLowerCase(),Be(),M()}),document.getElementById("visualization-type")?.addEventListener("change",C),document.getElementById("refresh-visualization")?.addEventListener("click",C),document.getElementById("apply-filters")?.addEventListener("click",C),document.getElementById("vis-search")?.addEventListener("input",t=>{}),document.getElementById("refresh-preview")?.addEventListener("click",N),document.getElementById("apply-preview-filters")?.addEventListener("click",N),document.getElementById("export-preview-pdf")?.addEventListener("click",ye),document.getElementById("export-preview-excel")?.addEventListener("click",he),document.getElementById("preview-search")?.addEventListener("input",t=>{}),document.getElementById("theme-toggle")?.addEventListener("click",ne),document.getElementById("btn-modify-intervenant")?.addEventListener("click",Ie),document.getElementById("btn-history-intervenant")?.addEventListener("click",Ee)}function C(){const t=document.getElementById("visualization-container"),e=document.getElementById("visualization-type")?.value||"timeline",n=document.getElementById("vis-start-date")?.value,s=document.getElementById("vis-end-date")?.value,a=document.getElementById("vis-search")?.value.toLowerCase();if(!t)return;let i=[...o.interventions];n&&(i=i.filter(r=>new Date(r.date)>=new Date(n))),s&&(i=i.filter(r=>new Date(r.date)<=new Date(s))),a&&(i=i.filter(r=>r.place.toLowerCase().includes(a)||r.type.toLowerCase().includes(a)||(r.intervenantStr||"").toLowerCase().includes(a))),t.innerHTML=`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2 text-muted">G√©n√©ration de la visualisation...</p>
        </div>
    `,setTimeout(()=>{switch(e){case"timeline":P(t,i);break;case"monthly":me(t,i);break;case"by-type":pe(t,i);break;case"by-place":fe(t,i);break;case"by-speaker":ge(t,i);break;default:P(t,i)}},100)}function P(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n=[...e].sort((a,i)=>new Date(a.date)-new Date(i.date));let s='<div class="timeline">';s+='<div class="row g-3">',n.forEach(a=>{const r=new Date(a.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"});s+=`
            <div class="col-md-6 col-lg-4">
                <div class="card border-start border-4 border-primary h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary">${a.type}</span>
                            <small class="text-muted">${r}</small>
                        </div>
                        <h6 class="card-title fw-bold">${a.intervenantStr||"Non assign√©"}</h6>
                        <p class="card-text small mb-1"><i class="fas fa-map-marker-alt me-1 text-muted"></i> ${a.place}</p>
                        ${a.description?`<p class="card-text small text-muted fst-italic">${a.description}</p>`:""}
                    </div>
                </div>
            </div>
        `}),s+="</div></div>",t.innerHTML=s}function me(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n={};e.forEach(i=>{const r=new Date(i.date),l=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;n[l]||(n[l]=[]),n[l].push(i)});const s=Object.keys(n).sort((i,r)=>new Date(r)-new Date(i));let a='<div class="monthly-visualization">';s.forEach(i=>{const l=new Date(i).toLocaleDateString("fr-FR",{month:"long",year:"numeric"}),c=n[i];a+=`
            <div class="card mb-3">
                <div class="card-header bg-light fw-bold">
                    <i class="fas fa-calendar me-2 text-primary"></i>${l} <span class="badge bg-primary ms-2">${c.length}</span>
                </div>
                <div class="card-body">
                    <div class="row g-2">
        `,c.forEach(d=>{const m=new Date(d.date).getDate();a+=`
                <div class="col-6 col-md-3 mb-2">
                    <div class="p-2 border rounded text-center">
                        <div class="fw-bold">${m}</div>
                        <small class="text-muted">${d.type}</small>
                    </div>
                </div>
            `}),a+=`
                    </div>
                </div>
            </div>
        `}),a+="</div>",t.innerHTML=a}function pe(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n={};e.forEach(a=>{n[a.type]=(n[a.type]||0)+1});const s="chart-by-type";t.innerHTML=`<canvas id="${s}"></canvas>`,setTimeout(()=>{const a=document.getElementById(s);if(a&&Object.keys(n).length>0){o.charts&&o.charts.byType&&o.charts.byType.destroy();const i=a.getContext("2d"),r=new y(i,{type:"doughnut",data:{labels:Object.keys(n),datasets:[{data:Object.values(n),backgroundColor:["#0d6efd","#198754","#ffc107","#dc3545","#6c757d","#0dcaf0","#20c997","#6610f2"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}});o.charts||(o.charts={}),o.charts.byType=r}},100)}function fe(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n={};e.forEach(a=>{n[a.place]=(n[a.place]||0)+1});const s="chart-by-place";t.innerHTML=`<canvas id="${s}"></canvas>`,setTimeout(()=>{const a=document.getElementById(s);if(a&&Object.keys(n).length>0){o.charts&&o.charts.byPlace&&o.charts.byPlace.destroy();const i=a.getContext("2d"),r=new y(i,{type:"bar",data:{labels:Object.keys(n),datasets:[{label:"Nombre d'interventions",data:Object.values(n),backgroundColor:"#0d6efd",borderRadius:5}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}});o.charts||(o.charts={}),o.charts.byPlace=r}},100)}function ge(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n={};e.forEach(i=>{const r=i.intervenantStr||"Non assign√©";n[r]=(n[r]||0)+1});const s=Object.entries(n).sort((i,r)=>r[1]-i[1]).slice(0,10),a="chart-by-speaker";t.innerHTML=`<canvas id="${a}"></canvas>`,setTimeout(()=>{const i=document.getElementById(a);if(i&&s.length>0){o.charts&&o.charts.bySpeaker&&o.charts.bySpeaker.destroy();const r=i.getContext("2d"),l=new y(r,{type:"bar",data:{labels:s.map(c=>c[0]),datasets:[{label:"Nombre d'interventions",data:s.map(c=>c[1]),backgroundColor:"#20c997",borderRadius:5}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}});o.charts||(o.charts={}),o.charts.bySpeaker=l}},100)}function N(){const t=document.getElementById("preview-container"),e=document.getElementById("preview-start-date")?.value,n=document.getElementById("preview-end-date")?.value,s=document.getElementById("preview-search")?.value.toLowerCase();if(!t)return;ve();let a=[...o.interventions];e&&(a=a.filter(i=>new Date(i.date)>=new Date(e))),n&&(a=a.filter(i=>new Date(i.date)<=new Date(n))),s&&(a=a.filter(i=>i.place.toLowerCase().includes(s)||i.type.toLowerCase().includes(s)||(i.intervenantStr||"").toLowerCase().includes(s))),t.innerHTML=`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2 text-muted">G√©n√©ration de l'aper√ßu...</p>
        </div>
    `,setTimeout(()=>{if(!a||a.length===0){t.innerHTML=`
                <div class="text-center py-5">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
                </div>
            `;return}const i=[...a].sort((l,c)=>new Date(l.date)-new Date(c.date));let r='<div class="preview-content">';r+=`
            <div class="text-center mb-4 pb-2 border-bottom">
                <img src="${o.config.logo}" id="preview-logo" alt="Logo" class="mb-2" style="max-height: 80px; max-width: 80px;">
                <h2 class="mb-1">${o.config.church}</h2>
                <p class="text-muted mb-0">${o.config.region} | ${o.config.section}</p>
                <p class="text-muted small mb-0">${o.config.phone?`T√©l√©phone: ${o.config.phone}`:""} ${o.config.email?`| Email: ${o.config.email}`:""}</p>
            </div>
        `,r+=`
            <div class="mb-4">
                <h4 class="text-center">Planning des Interventions</h4>
                <p class="text-center text-muted small">
                    ${e?`Du ${new Date(e).toLocaleDateString("fr-FR")}`:"Toutes les dates"}
                    ${n?`au ${new Date(n).toLocaleDateString("fr-FR")}`:""}
                </p>
            </div>
        `,r+=`
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Jour</th>
                            <th>Type</th>
                            <th>Lieu</th>
                            <th>Intervenant</th>
                            <th>Th√®me</th>
                        </tr>
                    </thead>
                    <tbody>
        `,i.forEach(l=>{const d=new Date(l.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"});r+=`
                <tr>
                    <td>${d}</td>
                    <td>${l.day}</td>
                    <td>${l.type}</td>
                    <td>${l.place}</td>
                    <td>${l.intervenantStr||"Non assign√©"}</td>
                    <td>${l.description||""}</td>
                </tr>
            `}),r+=`
                    </tbody>
                </table>
            </div>
        `,r+=`
            <div class="mt-5 pt-3 border-top text-center text-muted small">
                <p>Document g√©n√©r√© le ${new Date().toLocaleDateString("fr-FR")} √† ${new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}</p>
                <p>¬© ${new Date().getFullYear()} - ${o.config.church}</p>
            </div>
        `,r+="</div>",t.innerHTML=r},100)}function ve(){const t=document.getElementById("preview-logo"),e=document.getElementById("preview-church-name"),n=document.getElementById("preview-church-details");t&&(t.src=o.config.logo,t.alt=o.config.church),e&&(e.textContent=o.config.church),n&&(n.textContent=`R√©gion: ${o.config.region} | Section: ${o.config.section}`)}async function ye(){u.showAlert("Export PDF en cours...","info");const t=document.getElementById("preview-start-date")?.value,e=document.getElementById("preview-end-date")?.value,n=document.getElementById("preview-search")?.value.toLowerCase();let s=[...o.interventions];t&&(s=s.filter(a=>new Date(a.date)>=new Date(t))),e&&(s=s.filter(a=>new Date(a.date)<=new Date(e))),n&&(s=s.filter(a=>a.place.toLowerCase().includes(n)||a.type.toLowerCase().includes(n)||(a.intervenantStr||"").toLowerCase().includes(n)));try{await x.exportToPdf(s,o.config,t,e),u.showAlert("Export PDF termin√© avec succ√®s !","success")}catch(a){console.error("Erreur lors de l'export PDF:",a),u.showAlert("Erreur lors de l'export PDF","danger")}}async function he(){u.showAlert("Export Excel en cours...","info");const t=document.getElementById("preview-start-date")?.value,e=document.getElementById("preview-end-date")?.value,n=document.getElementById("preview-search")?.value.toLowerCase();let s=[...o.interventions];t&&(s=s.filter(a=>new Date(a.date)>=new Date(t))),e&&(s=s.filter(a=>new Date(a.date)<=new Date(e))),n&&(s=s.filter(a=>a.place.toLowerCase().includes(n)||a.type.toLowerCase().includes(n)||(a.intervenantStr||"").toLowerCase().includes(n)));try{await x.exportToExcel(s,o.config,t,e),u.showAlert("Export Excel termin√© avec succ√®s !","success")}catch(a){console.error("Erreur lors de l'export Excel:",a),u.showAlert("Erreur lors de l'export Excel","danger")}}function be(){const t=document.getElementById("date");t&&(t.value||(t.value=o.currentDate,L(o.currentDate)),t.addEventListener("change",e=>{o.currentDate=e.target.value,L(e.target.value),w(document.getElementById("intervenant").value)}))}function L(t){const e=document.getElementById("day-display"),n=document.getElementById("day-text");if(!t){e.style.display="none";return}const s=new Date(t);isNaN(s)||(n.textContent=I.DAYS_OF_WEEK[s.getDay()],e.style.display="block")}async function A(){u.toggleLoading(!0);try{const[t,e,n]=await Promise.all([g.getIntervenants(),g.getInterventions(),g.getConfig("global_config")]);o.intervenants=t,o.interventions=e,n&&(o.config={...o.config,...n},["church","region","section","year","quarter","phone","email","bank","logo"].forEach(a=>{const i=document.getElementById(`config-${a}`);i&&(i.value=o.config[a]||"")})),w(document.getElementById("intervenant").value),M(),u.updateSyncStatus("synced")}catch(t){console.error(t),u.showAlert("Erreur chargement","danger")}finally{u.toggleLoading(!1)}}async function we(){o.config={church:document.getElementById("config-church").value,region:document.getElementById("config-region").value,section:document.getElementById("config-section").value,year:document.getElementById("config-year").value,quarter:document.getElementById("config-quarter").value,phone:document.getElementById("config-phone").value,email:document.getElementById("config-email").value,bank:document.getElementById("config-bank").value,logo:document.getElementById("config-logo").value},u.toggleLoading(!0);try{await g.saveConfig("global_config",o.config),u.showAlert("Configuration et En-t√™te enregistr√©s !","success")}catch(t){console.error(t),u.showAlert("Erreur lors de l'enregistrement","danger")}finally{u.toggleLoading(!1)}}function w(t=null){const e=document.getElementById("intervenant"),n=document.getElementById("date").value;if(!e)return;const s=t||e.value;e.innerHTML='<option value="">S√©lectionner...</option>',o.intervenants.sort((a,i)=>a.last_name.localeCompare(i.last_name)),o.intervenants.forEach(a=>{const i=document.createElement("option");i.value=a.id;const r=o.interventions.find(l=>l.date===n&&l.intervenantId===a.id);r?(i.textContent=`üö´ ${a.title?`${a.title} `:""}${a.last_name.toUpperCase()} ${a.first_name} (D√©j√† pris : ${r.type})`,i.disabled=!0,i.classList.add("text-danger")):i.textContent=`${a.title?`${a.title} `:""}${a.last_name.toUpperCase()} ${a.first_name}`,e.appendChild(i)}),s&&(e.value=s)}async function Ee(){const e=document.getElementById("intervenant").value;if(!e){u.showAlert("Veuillez d'abord s√©lectionner un intervenant","warning");return}await xe(e)}async function Ie(){const e=document.getElementById("intervenant").value;if(!e){u.showAlert("Veuillez d'abord s√©lectionner un intervenant","warning");return}const n=o.intervenants.find(s=>s.id===e);if(!n){u.showAlert("Intervenant non trouv√©","danger");return}await le(n)}async function xe(t){try{const e=await g.getInterventionsByIntervenant(t),n=o.intervenants.find(s=>s.id===t);if(!n){u.showAlert("Intervenant non trouv√©","danger");return}await Se(n,e)}catch(e){console.error("Erreur lors de la r√©cup√©ration de l'historique:",e),u.showAlert("Erreur lors de la r√©cup√©ration de l'historique","danger")}}function Se(t,e){return new Promise(n=>{let s=document.getElementById("history-modal");s||(s=De());const a=s.querySelector(".modal-title");a.innerHTML=`<i class="fas fa-history me-2"></i>Historique de ${t.title?`${t.title} `:""}${t.last_name.toUpperCase()} ${t.first_name}`;const i=s.querySelector(".modal-body");if(e.length===0)i.innerHTML='<div class="text-center py-4"><i class="fas fa-inbox fa-2x text-muted mb-3"></i><p class="text-muted">Aucune intervention enregistr√©e</p></div>';else{let l='<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Date</th><th>Type</th><th>Lieu</th><th>Th√®me</th></tr></thead><tbody>';e.forEach(c=>{const f=new Date(c.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"});l+=`<tr><td>${f}</td><td>${c.type}</td><td>${c.place}</td><td>${c.description||""}</td></tr>`}),l+="</tbody></table></div>",i.innerHTML=l}const r=new b(s);s.addEventListener("hidden.bs.modal",()=>{n(!1)},{once:!0}),r.show()})}function De(){return document.body.insertAdjacentHTML("beforeend",`
        <div class="modal fade" id="history-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-info text-white py-2">
                        <h6 class="modal-title small fw-bold"></h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-3">
                        <!-- Historique sera charg√© ici -->
                    </div>
                    <div class="modal-footer bg-light py-2">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
    `),document.getElementById("history-modal")}function T(){return o.interventions.filter(t=>{if(!o.searchQuery)return!0;const e=o.searchQuery;return t.place.toLowerCase().includes(e)||t.type.toLowerCase().includes(e)||(t.intervenantStr||"").toLowerCase().includes(e)})}function M(){const t=document.getElementById("planning-container"),e=document.getElementById("count-badge");if(!t)return;const n=T();if(e.textContent=n.length,n.length===0){t.innerHTML='<div class="text-center text-muted py-5"><small>Aucune donn√©e</small></div>';return}t.innerHTML=n.map(s=>{const a=new Date(s.date);return`
        <div class="list-group-item border-0 border-bottom py-3">
            <div class="d-flex align-items-center">
                <div class="text-center me-3 border rounded px-2 py-1 bg-white shadow-sm" style="min-width: 60px;">
                    <div class="h5 mb-0 fw-bold text-dark">${a.getDate()}</div>
                    <div class="small text-uppercase text-muted" style="font-size: 0.65rem;">${a.toLocaleDateString("fr-FR",{month:"short"})}</div>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        <span class="badge bg-primary me-2" style="font-size: 0.7em;">${s.type}</span>
                        <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>${s.place}</small>
                        <small class="text-muted ms-2 border-start ps-2">${s.day}</small>
                    </div>
                    <h6 class="mb-0 fw-bold text-dark">${s.intervenantStr||s.intervenant?.last_name||"Non assign√©"}</h6>
                    ${s.description?`<div class="small text-muted mt-1 fst-italic text-truncate" style="max-width: 300px;">${s.description}</div>`:""}
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-link text-success opacity-75 hover-opacity-100 p-0" onclick="window.sendWhatsAppReminder('${s.id}')" title="Rappel WhatsApp">
                        <i class="fab fa-whatsapp fa-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-primary opacity-75 hover-opacity-100 p-0" onclick="window.editIntervention('${s.id}')" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-info opacity-75 hover-opacity-100 p-0" onclick="showComments('${s.id}')" title="Commentaires">
                        <i class="fas fa-comments"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-warning opacity-75 hover-opacity-100 p-0" onclick="showFeedback('${s.id}')" title="Feedback">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-danger opacity-50 hover-opacity-100 p-0" onclick="window.deleteIntervention('${s.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>`}).join("")}function Be(){const t={search:o.searchQuery};localStorage.setItem("ad_planning_prefs",JSON.stringify(t))}function Le(){const t=localStorage.getItem("ad_planning_prefs");if(t)try{const e=JSON.parse(t);e.search&&(o.searchQuery=e.search,document.getElementById("search-input").value=e.search)}catch(e){console.error("Erreur chargement prefs",e)}}async function Ae(){const t=document.getElementById("date").value,e=document.getElementById("type").value;if(!t||!e){u.showAlert("Veuillez d'abord s√©lectionner une date et un type.","warning");return}const n=document.getElementById("modalSuggestions"),s=new b(n);s.show(),document.getElementById("suggestions-list").innerHTML='<div class="text-center py-4"><div class="spinner-border text-warning" role="status"></div><p class="mt-2 small text-muted">Analyse IA...</p></div>';try{const i=(await z.getSuggestions(t,e)).map(r=>{const l=r.score>80?"success":r.score>50?"warning":"secondary";return`<a href="#" class="list-group-item list-group-item-action p-3 suggestion-item" data-id="${r.id}"><div class="d-flex w-100 justify-content-between align-items-center"><div><h6 class="mb-1 fw-bold text-dark">${r.first_name} ${r.last_name} <small class="text-muted fw-normal">(${r.title||"Membre"})</small></h6><div class="small text-muted">${r.reasons.map(c=>`<span>‚Ä¢ ${c}</span>`).join(" ")}</div></div><div class="text-end"><span class="badge bg-${l} rounded-pill">${r.score}%</span></div></div></a>`}).join("");document.getElementById("suggestions-list").innerHTML=i||'<div class="p-3 text-center">Aucune suggestion.</div>',document.querySelectorAll(".suggestion-item").forEach(r=>{r.addEventListener("click",l=>{l.preventDefault();const c=r.dataset.id;document.getElementById("intervenant").value=c,s.hide(),document.getElementById("intervenant").classList.add("is-valid"),setTimeout(()=>document.getElementById("intervenant").classList.remove("is-valid"),2e3)})})}catch(a){console.error(a),document.getElementById("suggestions-list").innerHTML=`<div class="text-danger p-3">Erreur lors de l'analyse.</div>`}}async function Ce(t){if(t.preventDefault(),!t.target.checkValidity()){t.stopPropagation(),t.target.classList.add("was-validated");return}u.toggleLoading(!0);try{const e=document.getElementById("date").value,n=document.getElementById("day-text").textContent,s=document.getElementById("place").value,a=document.getElementById("type").value,i=document.getElementById("theme").value,r=document.getElementById("obs").value,l=document.getElementById("intervenant").value,c=document.getElementById("intervenant").options[document.getElementById("intervenant").selectedIndex].text,d=document.getElementById("recurrence").value,f=document.getElementById("recurrence-end-date").value;let m=i;if(r&&(m+=(m?" | ":"")+r),o.editingId){const v={date:e,day:n!=="..."?n:I.DAYS_OF_WEEK[new Date(e).getDay()],place:s,type:a,description:m,intervenantId:l,intervenantStr:c,recurrence:d,recurrence_end_date:f};await g.updateIntervention(o.editingId,v),u.showAlert("Intervention mise √† jour !","success"),o.editingId=null;const E=document.querySelector('#main-form button[type="submit"]');E&&(E.innerHTML='<i class="fas fa-plus"></i> Ajouter',E.classList.remove("btn-warning"),E.classList.add("btn-primary")),D("Planification mise √† jour","success",!0)}else{const v={date:e,day:n!=="..."?n:I.DAYS_OF_WEEK[new Date(e).getDay()],place:s,type:a,description:m,intervenantId:l,intervenantStr:c,recurrence:d,recurrence_end_date:f};d!=="none"?await re(v):await g.addIntervention(v),u.showAlert("Enregistr√© !","success"),D("Nouvelle planification ajout√©e","success",!0)}t.target.reset(),t.target.classList.remove("was-validated"),L(o.currentDate),document.getElementById("date").value=o.currentDate,await A()}catch(e){u.showAlert("Erreur: "+e.message,"danger")}finally{u.toggleLoading(!1)}}async function ke(t){t.preventDefault();const e=t.target.querySelector('button[type="submit"]'),n=e.innerHTML;e.innerHTML='<i class="fas fa-spinner fa-spin"></i>',e.disabled=!0;try{const s={title:document.getElementById("modal-iv-title").value,first_name:document.getElementById("modal-iv-firstname").value,last_name:document.getElementById("modal-iv-lastname").value,category:"members"},a=await g.addIntervenant(s),i=document.getElementById("modalNewIntervenant");b.getInstance(i).hide(),o.intervenants.push(a),w(a.id),t.target.reset(),u.showAlert("Intervenant cr√©√© !","success")}catch(s){alert("Erreur: "+s.message)}finally{e.innerHTML=n,e.disabled=!1}}window.deleteIntervention=async t=>{if(confirm("Supprimer ?"))try{await g.deleteIntervention(t),await A(),D("Planification supprim√©e","danger",!0)}catch(e){console.error(e)}};window.sendWhatsAppReminder=t=>{const e=o.interventions.find(l=>l.id===t);if(!e)return;const n=new Date(e.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}),s=e.intervenantStr||(e.intervenant?`${e.intervenant.first_name} ${e.intervenant.last_name}`:"Bien-aim√©"),a=e.description?` sur le th√®me : "${e.description}"`:"",i=`Bonjour ${s}, c'est le secr√©tariat de l'√©glise AD BERACA. 

Rappel pour votre intervention (${e.type}) pr√©vue ce ${n} √† ${e.place}${a}. 

Soyez richement b√©ni !`,r=`https://wa.me/?text=${encodeURIComponent(i)}`;window.open(r,"_blank")};window.editIntervention=async t=>{const e=o.interventions.find(i=>i.id===t);if(!e){u.showAlert("Intervention non trouv√©e","danger");return}document.getElementById("date").value=e.date,document.getElementById("day-text").textContent=e.day,document.getElementById("place").value=e.place,document.getElementById("type").value=e.type;const n=e.description?e.description.split(" | "):[];if(n.length>0&&(document.getElementById("theme").value=n[0]||""),n.length>1?document.getElementById("obs").value=n.slice(1).join(" | "):document.getElementById("obs").value="",e.intervenant)document.getElementById("intervenant").value=e.intervenant.id;else{const i=o.intervenants.find(r=>r.last_name===e.intervenantStr?.split(" ")[0]&&r.first_name===e.intervenantStr?.split(" ")[1]);i?document.getElementById("intervenant").value=i.id:document.getElementById("intervenant").value=""}document.getElementById("main-form").scrollIntoView({behavior:"smooth"});const s=document.querySelector('#main-nav button[data-view="form-view"]');s&&s.click(),o.editingId=t;const a=document.querySelector('#main-form button[type="submit"]');a&&(a.innerHTML='<i class="fas fa-save"></i> Mettre √† jour',a.classList.add("btn-warning"),a.classList.remove("btn-primary"))};
