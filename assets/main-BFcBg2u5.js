(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();const E={SUPABASE_URL:"https://supywgkoghcphlynktmr.supabase.co",SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1cHl3Z2tvZ2hjcGhseW5rdG1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NTYzNjQsImV4cCI6MjA4MjQzMjM2NH0.b_6COwOKkt2sWOuzM42W-LZfraPJJSKXhax69IUGwWc",ADMIN_CODE:"Sarah2017"},I={DAYS_OF_WEEK:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],CULT_TYPES_BY_DAY:{Dimanche:["Principal","Enseignement","Culte des enfants","Culte des Adolescents"],Lundi:["R√©union"],Mardi:["Pri√®re hebdomadaire","Enseignement"],Mercredi:["Enseignement","R√©union","Culte des Adolescents"],Jeudi:["T√©moignage/Action de gr√¢ce/Pri√®re","R√©union"],Vendredi:["Enseignement","Veill√©e de pri√®re","R√©union"],Samedi:["Jeune et Pri√®re","Veill√©e de pri√®re","Culte des Adolescents"]}},C=window.supabase?window.supabase.createClient:null;C||console.error("Critical Error: Supabase library not loaded. Check CDN script in index.html.");let H=null;if(C&&E.SUPABASE_URL&&E.SUPABASE_ANON_KEY)try{H=C(E.SUPABASE_URL,E.SUPABASE_ANON_KEY)}catch(t){console.error("Supabase initialization error:",t)}else console.warn("Supabase not initialized: URL or Key missing.");const m=H;async function q(){if(!m)return console.error("Supabase client not initialized"),!1;try{const{data:t,error:e}=await m.from("interventions").select("*").limit(1);return e?(console.error("Connection test error:",e),!1):(console.log("Supabase connection successful:",t),!0)}catch(t){return console.error("Connection test error:",t),!1}}const g={async getIntervenants(){const{data:t,error:e}=await m.from("intervenants").select("*").eq("is_active",!0).order("last_name",{ascending:!0});if(e)throw e;return t},async addIntervenant(t){const{data:e,error:n}=await m.from("intervenants").insert([t]).select().single();if(n)throw n;return await this.addAuditLog("INSERT","intervenants",e.id,null,e),e},async updateIntervenant(t,e){const{data:n,error:r}=await m.from("intervenants").select("*").eq("id",t).single();if(r)throw r;const{data:a,error:s}=await m.from("intervenants").update(e).eq("id",t).select().single();if(s)throw s;return await this.addAuditLog("UPDATE","intervenants",t,n,a),a},async getInterventions(t,e){let n=m.from("interventions").select(`
                *,
                intervenants (
                    id, title, first_name, last_name, category
                )
            `).order("date",{ascending:!0});t&&(n=n.gte("date",t)),e&&(n=n.lte("date",e));const{data:r,error:a}=await n;if(a)throw a;return r.map(s=>({id:s.id,date:s.date,day:s.day_of_week,type:s.cult_type,place:s.place,description:s.description,intervenant:s.intervenants,intervenantStr:s.intervenants?`${s.intervenants.title?`${s.intervenants.title} `:""}${s.intervenants.last_name.toUpperCase()} ${s.intervenants.first_name}`.trim():s.intervenant_name_snapshot}))},async addIntervention(t){const e={date:t.date,day_of_week:t.day,cult_type:t.type,place:t.place,description:t.description||"",intervenant_name_snapshot:t.intervenantStr,recurrence_pattern:t.recurrence||"none",recurrence_end_date:t.recurrence_end_date||null};t.intervenantId&&(e.intervenant_id=t.intervenantId);const{data:n,error:r}=await m.from("interventions").insert([e]).select();if(r)throw r;return await this.addAuditLog("INSERT","interventions",n[0].id,null,n[0]),n[0]},async updateIntervention(t,e){const{data:n,error:r}=await m.from("interventions").select("*").eq("id",t).single();if(r)throw r;const a={date:e.date,day_of_week:e.day,cult_type:e.type,place:e.place,description:e.description||"",intervenant_name_snapshot:e.intervenantStr,recurrence_pattern:e.recurrence||"none",recurrence_end_date:e.recurrence_end_date||null};e.intervenantId&&(a.intervenant_id=e.intervenantId);const{data:s,error:i}=await m.from("interventions").update(a).eq("id",t).select();if(i)throw i;return await this.addAuditLog("UPDATE","interventions",t,n,s[0]),s[0]},async getInterventionsByIntervenant(t,e,n){let r=m.from("interventions").select(`
                *,
                intervenants (
                    id, title, first_name, last_name, category
                )
            `).eq("intervenant_id",t).order("date",{ascending:!1});e&&(r=r.gte("date",e)),n&&(r=r.lte("date",n));const{data:a,error:s}=await r;if(s)throw s;return a.map(i=>({id:i.id,date:i.date,day:i.day_of_week,type:i.cult_type,place:i.place,description:i.description,intervenant:i.intervenants,intervenantStr:i.intervenants?`${i.intervenants.title?`${i.intervenants.title} `:""}${i.intervenants.last_name.toUpperCase()} ${i.intervenants.first_name}`.trim():i.intervenant_name_snapshot}))},async deleteIntervention(t){const{data:e,error:n}=await m.from("interventions").select("*").eq("id",t).single();if(n)throw n;const{error:r}=await m.from("interventions").delete().eq("id",t);if(r)throw r;return await this.addAuditLog("DELETE","interventions",t,e,null),!0},async clearAllInterventions(){const{error:t}=await m.from("interventions").delete().neq("id","00000000-0000-0000-0000-000000000000");if(t)throw t;return!0},async addComment(t,e,n="Anonyme"){const r={intervention_id:t,content:e,author:n,created_at:new Date().toISOString()},{data:a,error:s}=await m.from("comments").insert([r]).select().single();if(s)throw s;return await this.addAuditLog("INSERT","comments",a.id,null,a),a},async getCommentsByIntervention(t){const{data:e,error:n}=await m.from("comments").select("*").eq("intervention_id",t).order("created_at",{ascending:!1});if(n)throw n;return e},async updateComment(t,e){const{data:n,error:r}=await m.from("comments").select("*").eq("id",t).single();if(r)throw r;const{data:a,error:s}=await m.from("comments").update({content:e,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(s)throw s;return await this.addAuditLog("UPDATE","comments",t,n,a),a},async deleteComment(t){const{data:e,error:n}=await m.from("comments").select("*").eq("id",t).single();if(n)throw n;const{error:r}=await m.from("comments").delete().eq("id",t);if(r)throw r;return await this.addAuditLog("DELETE","comments",t,e,null),!0},async addFeedback(t,e,n="",r="Anonyme"){const a={intervention_id:t,rating:e,comment:n,author:r,created_at:new Date().toISOString()},{data:s,error:i}=await m.from("feedbacks").insert([a]).select().single();if(i)throw i;return await this.addAuditLog("INSERT","feedbacks",s.id,null,s),s},async getFeedbacksByIntervention(t){const{data:e,error:n}=await m.from("feedbacks").select("*").eq("intervention_id",t).order("created_at",{ascending:!1});if(n)throw n;return e},async getAverageRatingByIntervention(t){const{data:e,error:n}=await m.from("feedbacks").select("rating").eq("intervention_id",t);if(n)throw n;return e.length===0?0:e.reduce((a,s)=>a+s.rating,0)/e.length},async updateFeedback(t,e,n){const{data:r,error:a}=await m.from("feedbacks").select("*").eq("id",t).single();if(a)throw a;const{data:s,error:i}=await m.from("feedbacks").update({rating:e,comment:n,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(i)throw i;return await this.addAuditLog("UPDATE","feedbacks",t,r,s),s},async getConfig(t){const{data:e,error:n}=await m.from("app_config").select("value").eq("key",t).maybeSingle();return n?(console.warn("Erreur lecture config:",n),null):e?e.value:null},async saveConfig(t,e){const{data:n,error:r}=await m.from("app_config").upsert({key:t,value:e}).select();if(r)throw r;return n},async addAuditLog(t,e,n,r=null,a=null){const s={action:t,table:e,record_id:n,old_values:r?JSON.stringify(r):null,new_values:a?JSON.stringify(a):null,timestamp:new Date().toISOString(),user_id:"system"},{error:i}=await m.from("audit_log").insert([s]);i&&console.error("Erreur lors de l'ajout au journal d'audit:",i)},async getAuditLogs(t=50,e=0){const{data:n,error:r}=await m.from("audit_log").select("*").order("timestamp",{ascending:!1}).range(e,e+t-1);return r?(console.error("Erreur lors de la r√©cup√©ration du journal d'audit:",r),[]):n}},j=t=>new Promise((e,n)=>{const r=new Image;r.crossOrigin="Anonymous",r.onload=()=>{const a=document.createElement("canvas");a.width=r.width,a.height=r.height,a.getContext("2d").drawImage(r,0,0),e(a.toDataURL("image/jpeg"))},r.onerror=a=>{console.warn("Erreur chargement logo, PDF sans logo",a),e(null)},r.src=t}),x={exportToExcel(t,e={}){const n=t.map(s=>({Date:new Date(s.date).toLocaleDateString("fr-FR"),Jour:s.day,Type:s.type,Lieu:s.place,"Th√®me/Desc":s.description||"",Intervenant:s.intervenantStr||s.intervenant?.last_name||"Non assign√©"})),r=XLSX.utils.json_to_sheet([]);XLSX.utils.sheet_add_aoa(r,[["ASSEMBL√âES DE DIEU DU B√âNIN"],[`√âglise: ${e.church||"AD BERACA"}`],[`R√©gion: ${e.region||""} | Section: ${e.section||""}`],[`Planning: ${e.year||""} - Trimestre ${e.quarter||""}`],[""]],{origin:"A1"}),XLSX.utils.sheet_add_json(r,n,{origin:"A6",skipHeader:!1});const a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,r,"Planning"),XLSX.writeFile(a,`Planning_AD_${e.church||"Beraca"}_${new Date().toISOString().slice(0,10)}.xlsx`)},async exportToPdf(t,e={}){const n=new jsPDF,r=e.logo&&e.logo.trim()!==""?e.logo:"AD.jpeg",a=await j(r);n.setFont("times","normal");const s=n.internal.pageSize.getWidth(),i=n.internal.pageSize.getHeight();let l=20;a&&n.addImage(a,"JPEG",14,10,20,20),n.setFontSize(18),n.setTextColor(44,62,80),n.text("ASSEMBL√âES DE DIEU DU B√âNIN",s/2,l,{align:"center"}),l+=8,n.setFontSize(14),n.setFont("times","bold"),n.text(`√âGLISE : ${e.church||"AD BERACA"}`,s/2,l,{align:"center"}),l+=7,n.setFontSize(11),n.setFont("times","normal"),n.setTextColor(100),n.text(`R√©gion: ${e.region||"ATACORA"} | Section: ${e.section||"NATITINGOU"}`,s/2,l,{align:"center"}),l+=5;let d="";e.phone&&(d+=`T√©l: ${e.phone} `),e.email&&(d+=`| Email: ${e.email}`),d&&(n.setFontSize(9),n.text(d.trim().replace(/^\| /,""),s/2,l,{align:"center"}),l+=5),n.setFontSize(11),n.setTextColor(44,62,80),n.text(`Planning Ann√©e: ${e.year||"2026"} - Trimestre: ${e.quarter||"1"}`,s/2,l,{align:"center"}),l+=5,n.setLineWidth(.5),n.setDrawColor(200),n.line(14,l,s-14,l);const c=["Date","Jour","Type","Lieu","Intervenant","D√©tails"],p=[];t.forEach(f=>{const v=[new Date(f.date).toLocaleDateString("fr-FR"),f.day,f.type,f.place,f.intervenantStr||(f.intervenant?`${f.intervenant.first_name} ${f.intervenant.last_name}`:""),f.description||""];p.push(v)}),autoTable(n,{head:[c],body:p,startY:l+10,theme:"grid",styles:{font:"times",fontSize:10,cellPadding:3,valign:"middle",lineWidth:.1,lineColor:[200,200,200]},headStyles:{fillColor:[240,240,240],textColor:[44,62,80],fontStyle:"bold",lineWidth:.1,lineColor:[100,100,100]},columnStyles:{0:{cellWidth:22},1:{cellWidth:22},2:{cellWidth:25},3:{cellWidth:25},4:{cellWidth:40,fontStyle:"bold"},5:{cellWidth:"auto"}},didDrawPage:function(f){e.bank&&(n.setFontSize(9),n.setTextColor(44,62,80),n.text(`Donn√©es Bancaires: ${e.bank}`,14,i-15)),n.setFontSize(8),n.setTextColor(150),n.text(`G√©n√©r√© le ${new Date().toLocaleDateString("fr-FR")} - Page ${n.internal.getNumberOfPages()}`,s-20,i-10,{align:"right"})}}),n.save(`Planning_AD_${e.church||"Beraca"}_${new Date().toISOString().slice(0,10)}.pdf`)}},O={async getSuggestions(t,e){console.log(`üß† Analyse IA pour : ${e} le ${t}`);const[n,r]=await Promise.all([g.getIntervenants(),g.getInterventions()]),a=F(e);return n.map(i=>{if(r.some(f=>f.date===t&&(f.intervenantId===i.id||f.intervenantStr===i.last_name)))return null;let d=100;const c=[],p=r.filter(f=>f.intervenantId===i.id).sort((f,v)=>new Date(v.date)-new Date(f.date));if(p.length>0){const f=p[0],v=(new Date(t)-new Date(f.date))/(1e3*60*60*24);v<7?(d-=50,c.push("üî¥ A parl√© tr√®s r√©cemment")):v>30?(d+=20,c.push(`üü¢ Dispo depuis ${Math.floor(v)} jours`)):c.push(`A parl√© il y a ${Math.floor(v)} jours`)}else d+=30,c.push("‚ú® Jamais intervenu");return a.includes(i.category)&&(d+=15,c.push("‚≠ê Profil adapt√© au type")),e.includes("Principal")&&(i.title==="Pasteur"||i.title==="Diacre")&&(d+=10),{...i,score:d,reasons:c}}).filter(i=>i!==null).sort((i,l)=>l.score-i.score).slice(0,5)}};function F(t){const e=t.toLowerCase();return e.includes("enseignement")||e.includes("principal")||e.includes("sainte c√®ne")?["clergy"]:e.includes("louange")?["singers","musicians"]:["clergy","members"]}const z={calculateStats(t){if(!t||t.length===0)return null;const e=t.length,n={};t.forEach(c=>{n[c.type]=(n[c.type]||0)+1});const r={};t.forEach(c=>{const p=c.intervenantStr||c.intervenant?.last_name||"Inconnu";r[p]=(r[p]||0)+1});const a=Object.entries(r).sort((c,p)=>p[1]-c[1]).slice(0,5),s=["Jan","F√©v","Mar","Avr","Mai","Juin","Juil","Ao√ªt","Sep","Oct","Nov","D√©c"],i=new Array(12).fill(0);t.forEach(c=>{const p=new Date(c.date);isNaN(p)||i[p.getMonth()]++});const l={};let d={name:"-",count:0};return t.forEach(c=>{l[c.place]=(l[c.place]||0)+1,l[c.place]>d.count&&(d={name:c.place,count:l[c.place]})}),{kpi:{total:e,topSpeaker:a[0]?a[0][0]:"-",topPlace:d.name},charts:{types:{labels:Object.keys(n),data:Object.values(n)},speakers:{labels:a.map(c=>c[0]),data:a.map(c=>c[1])},timeline:{labels:s,data:i}}}}},S={async requestPermission(){return"Notification"in window?await Notification.requestPermission()==="granted"?(console.log("Permission accord√©e pour les notifications"),!0):!1:(console.log("Ce navigateur ne supporte pas les notifications bureau"),!1)},async getNotifications(t){if(!t)return[];const{data:e,error:n}=await m.from("notifications").select("*").eq("user_id",t).order("created_at",{ascending:!1}).limit(20);return n?(console.error("Erreur r√©cup notifications:",n),[]):e},async markAsRead(t){const{error:e}=await m.from("notifications").update({is_read:!0}).eq("id",t);return!e},async markAllAsRead(t){const{error:e}=await m.from("notifications").update({is_read:!0}).eq("user_id",t).eq("is_read",!1);return!e}},U=window.bootstrap.Alert,u={showAlert(t,e="info"){const n=document.getElementById("alert-placeholder");if(!n)return;const r=document.createElement("div");r.innerHTML=[`<div class="alert alert-${e} alert-dismissible fade show" role="alert">`,`   <div>${t}</div>`,'   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',"</div>"].join(""),n.append(r),setTimeout(()=>{const a=r.querySelector(".alert");if(a){const s=U.getOrCreateInstance(a);s&&s.close()}},5e3)},toggleLoading(t){let e=document.getElementById("global-loader");!e&&t&&(e=document.createElement("div"),e.id="global-loader",e.style.cssText=`
                position: fixed;
                top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex; justify-content: center; align-items: center;
                z-index: 9999;
            `,e.innerHTML='<div class="spinner-border text-light" role="status"><span class="visually-hidden">Chargement...</span></div>',document.body.appendChild(e)),e&&(e.style.display=t?"flex":"none")},updateSyncStatus(t){const e={loading:"fas fa-sync-alt fa-spin",synced:"fas fa-check-circle text-success",error:"fas fa-exclamation-triangle text-danger",saved:"fas fa-save text-primary"},n={loading:"Chargement...",synced:"Synchronis√©",error:"Erreur",saved:"Sauvegard√©"},r=document.getElementById("sync-indicator");r&&(r.innerHTML=`<i class="${e[t]||""}"></i> <span class="d-none d-md-inline">${n[t]||""}</span>`)}},h=window.bootstrap.Modal,y=window.Chart;function R(t){let e=0;for(let n=0;n<t.length;n++){const r=t.charCodeAt(n);e=(e<<5)-e+r,e|=0}return e}const o={interventions:[],intervenants:[],config:{church:"AD BERACA",region:"ATACORA",section:"NATITINGOU",year:new Date().getFullYear(),quarter:Math.floor((new Date().getMonth()+3)/3),phone:"",email:"",bank:"",logo:"AD.jpeg"},searchQuery:"",currentDate:new Date().toISOString().split("T")[0],charts:{},passwordHash:1234567890,isAuthenticated:!1};function V(){const t="Martial1989";o.passwordHash=R(t)}function A(t,e="info",n=!0){u.showAlert(t,e),n&&J()}function J(){const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),n=t.createGain();e.connect(n),n.connect(t.destination),e.type="sine",e.frequency.value=800,n.gain.value=.3,e.start(),n.gain.exponentialRampToValueAtTime(1e-5,t.currentTime+.5),setTimeout(()=>{e.stop()},500)}function W(t,e){const n={added:[],updated:[],deleted:[]},r=new Map(t.map(s=>[s.id,s])),a=new Map(e.map(s=>[s.id,s]));for(const[s,i]of r)a.has(s)||n.deleted.push(i);for(const[s,i]of a){const l=r.get(s);l?JSON.stringify(l)!==JSON.stringify(i)&&n.updated.push({old:l,new:i}):n.added.push(i)}return n}function Y(t){const e=[];if(t.added.length>0){const n=t.added.length;e.push(`${n} nouvelle${n>1?"s":""} planification${n>1?"s":""} ajout√©e${n>1?"s":""}`)}if(t.updated.length>0){const n=t.updated.length;e.push(`${n} planification${n>1?"s":""} modifi√©e${n>1?"s":""}`)}if(t.deleted.length>0){const n=t.deleted.length;e.push(`${n} planification${n>1?"s":""} supprim√©e${n>1?"s":""}`)}return e.join(", ")}async function X(){try{const t=[...o.interventions],e=await g.getInterventions();o.interventions=e;const n=W(t,e);if(n.added.length>0||n.updated.length>0||n.deleted.length>0){const r=Y(n);A(r,"info",!0),T()}}catch(t){console.error("Erreur lors de la v√©rification des modifications:",t)}}function G(){setInterval(X,3e4)}function K(){G(),o.initialInterventions=[...o.interventions]}V();async function Q(){ee(),await q()||u.showAlert("Erreur de connexion √† la base de donn√©es. Veuillez v√©rifier la configuration des secrets sur GitHub.","danger"),ce(),ne(),he(),Le(),await B(),Z(),K()}document.addEventListener("DOMContentLoaded",Q);"serviceWorker"in navigator&&window.addEventListener("load",()=>console.log("PWA Ready"));async function Z(){const t=document.getElementById("btn-notifications");document.getElementById("notifications-list"),document.getElementById("notification-badge");const e=document.getElementById("btn-mark-all-read");t&&(await L(),t.addEventListener("click",async()=>{Notification.permission==="default"&&await S.requestPermission()&&console.log("Web Push activ√© pour cet utilisateur")}),e?.addEventListener("click",async n=>{n.stopPropagation(),await S.markAllAsRead("00000000-0000-0000-0000-000000000000"),await L()}))}async function L(){const t=document.getElementById("notifications-list"),e=document.getElementById("notification-badge"),n=await S.getNotifications("00000000-0000-0000-0000-000000000000"),r=n.filter(a=>!a.is_read).length;if(r>0?(e.textContent=r,e.style.display="block"):e.style.display="none",n.length===0){t.innerHTML='<div class="text-center py-3 text-muted small">Aucune notification</div>';return}t.innerHTML=n.map(a=>`
        <button class="list-group-item list-group-item-action p-2 border-start-0 border-end-0 ${a.is_read?"":"bg-light fw-bold"}" 
                onclick="markNotificationRead('${a.id}')">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small text-primary">${a.type}</span>
                <span class="text-muted" style="font-size: 0.7rem;">${new Date(a.created_at).toLocaleDateString()}</span>
            </div>
            <p class="mb-0 small text-truncate">${a.title}</p>
            <p class="mb-0 text-muted" style="font-size: 0.75rem;">${a.message}</p>
        </button>
    `).join("")}window.markNotificationRead=async t=>{await S.markAsRead(t),await L()};window.testNotif=async()=>{console.log("Envoi d'une notification de test...");const t={user_id:"00000000-0000-0000-0000-000000000000",title:"Rappel de culte",message:"N'oubliez pas le culte de ce soir √† 19h.",type:"reminder",channel:"in_app",is_read:!1};try{const{error:e}=await supabaseClient.from("notifications").insert([t]);if(e){console.warn("Table 'notifications' non trouv√©e ou erreur RLS. Mode simulation activ√©.",e);const n=document.getElementById("notifications-list"),r=document.getElementById("notification-badge");r.style.display="block",r.textContent=parseInt(r.textContent||"0")+1;const a=`
            <button class="list-group-item list-group-item-action p-2 border-start-0 border-end-0 bg-light fw-bold">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small text-primary">Test</span>
                    <span class="text-muted" style="font-size: 0.7rem;">√Ä l'instant</span>
                </div>
                <p class="mb-0 small text-truncate">${t.title}</p>
                <p class="mb-0 text-muted" style="font-size: 0.75rem;">${t.message}</p>
            </button>`;n.innerHTML.includes("Aucune notification")?n.innerHTML=a:n.insertAdjacentHTML("afterbegin",a)}else console.log("Notification ins√©r√©e dans Supabase !"),await L()}catch(e){console.error(e)}};function ee(){const t=localStorage.getItem("app-theme"),e=window.matchMedia("(prefers-color-scheme: dark)").matches;t==="dark"||!t&&e?(document.documentElement.setAttribute("data-theme","dark"),_("dark")):(document.documentElement.setAttribute("data-theme","light"),_("light"))}function te(){const e=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("app-theme",e),_(e)}function _(t){const e=document.getElementById("theme-toggle");if(!e)return;const n=e.querySelector("i");n&&(n.className=t==="dark"?"fas fa-sun":"fas fa-moon",e.title=t==="dark"?"Passer en mode clair":"Passer en mode sombre")}function ne(){const t=document.querySelectorAll("#main-nav button[data-view]");t.forEach(e=>{e.addEventListener("click",async n=>{const r=n.currentTarget.dataset.view;if(r==="settings-view"&&!o.isAuthenticated){if(!await ae())return;o.isAuthenticated=!0}t.forEach(a=>{a.classList.remove("active","opacity-100"),a.classList.add("opacity-75")}),n.currentTarget.classList.add("active","opacity-100"),n.currentTarget.classList.remove("opacity-75"),document.querySelectorAll(".view-section").forEach(a=>{a.style.display="none"}),document.getElementById(r).style.display="block",r==="dashboard-view"&&de()})})}function ae(){return new Promise(t=>{let e=document.getElementById("password-modal");e?M(e,t):(e=re(),setTimeout(()=>{M(e,t)},0))})}function M(t,e){const n=t.querySelector("#password-input"),r=t.querySelector("#password-submit"),a=t.querySelector("#password-error");if(!n||!r||!a){console.error("√âl√©ments de la modale non trouv√©s"),e(!1);return}const s=new h(t);n.value="",a.style.display="none",n.classList.remove("is-invalid");const i=()=>{const d=n.value;R(d)===o.passwordHash?(s.hide(),e(!0)):(a.style.display="block",n.classList.add("is-invalid"),n.focus())};r.onclick=null,n.onkeypress=null,r.onclick=i,n.onkeypress=d=>{d.key==="Enter"&&i()};const l=()=>{t.removeEventListener("hidden.bs.modal",l),e(!1)};t.addEventListener("hidden.bs.modal",l),s.show(),n.focus()}function re(){return document.body.insertAdjacentHTML("beforeend",`
        <div class="modal fade" id="password-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-primary text-white py-3">
                        <h5 class="modal-title fw-bold"><i class="fas fa-lock me-2"></i>Acc√®s restreint</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <p class="mb-3">Veuillez entrer le mot de passe pour acc√©der √† la page de configuration :</p>
                        <div class="mb-3">
                            <label for="password-input" class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="password-input" placeholder="Entrez le mot de passe">
                            <div id="password-error" class="text-danger mt-2" style="display: none;">
                                <i class="fas fa-exclamation-circle me-1"></i>Mot de passe incorrect
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light py-2">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary btn-sm" id="password-submit">Valider</button>
                    </div>
                </div>
            </div>
        </div>
    `),document.getElementById("password-modal")}async function se(t){const{date:e,recurrence:n,recurrence_end_date:r,...a}=t,s=r?new Date(r):new Date(e);s.setFullYear(s.getFullYear()+1);const i=new Date(e),l=[];let d=new Date(i);for(;d<=s;){const c={...a,date:d.toISOString().split("T")[0],day:I.DAYS_OF_WEEK[d.getDay()]};switch(l.push(c),n){case"daily":d.setDate(d.getDate()+1);break;case"weekly":d.setDate(d.getDate()+7);break;case"monthly":d.setMonth(d.getMonth()+1);break;case"yearly":d.setFullYear(d.getFullYear()+1);break;default:d.setDate(d.getDate()+1)}}for(const c of l)try{await g.addIntervention(c)}catch(p){console.error("Erreur lors de l'ajout de l'intervention r√©currente:",p)}u.showAlert(`${l.length} interventions r√©currentes cr√©√©es !`,"success")}async function ie(t,e){try{const n=await g.updateIntervenant(t,e),r=o.intervenants.findIndex(a=>a.id===t);return r!==-1&&(o.intervenants[r]=n),b(),u.showAlert("Intervenant mis √† jour avec succ√®s !","success"),n}catch(n){throw console.error("Erreur lors de la mise √† jour de l'intervenant:",n),u.showAlert("Erreur lors de la mise √† jour de l'intervenant","danger"),n}}function oe(t){return new Promise(e=>{let n=document.getElementById("edit-intervenant-modal");n||(n=le()),document.getElementById("edit-iv-title").value=t.title||"",document.getElementById("edit-iv-firstname").value=t.first_name||"",document.getElementById("edit-iv-lastname").value=t.last_name||"",document.getElementById("edit-iv-category").value=t.category||"members",n.dataset.intervenantId=t.id;const r=new h(n),a=async()=>{const l=n.querySelector("#edit-intervenant-submit"),d=l.innerHTML;l.innerHTML='<i class="fas fa-spinner fa-spin"></i>',l.disabled=!0;try{const c={title:document.getElementById("edit-iv-title").value,first_name:document.getElementById("edit-iv-firstname").value,last_name:document.getElementById("edit-iv-lastname").value,category:document.getElementById("edit-iv-category").value};await ie(t.id,c),r.hide(),e(!0)}catch{e(!1)}finally{l.innerHTML=d,l.disabled=!1}},s=n.querySelector("#edit-intervenant-submit");s.onclick=null,s.onclick=a;const i=n.querySelector(".modal-body form");i.onkeypress=l=>{l.key==="Enter"&&l.target.tagName!=="TEXTAREA"&&(l.preventDefault(),a())},n.addEventListener("hidden.bs.modal",()=>{e(!1)},{once:!0}),r.show()})}function le(){return document.body.insertAdjacentHTML("beforeend",`
        <div class="modal fade" id="edit-intervenant-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-warning text-dark py-2">
                        <h6 class="modal-title small fw-bold"><i class="fas fa-user-edit me-2"></i>Modifier Intervenant</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-3">
                        <form id="form-edit-intervenant">
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">Titre</label>
                                <select class="form-select form-select-sm" id="edit-iv-title">
                                    <option value="">Aucun</option>
                                    <option value="Pasteur">Pasteur</option>
                                    <option value="Diacre">Diacre</option>
                                    <option value="Ancien">Ancien</option>
                                    <option value="Fr√®re">Fr√®re</option>
                                    <option value="S≈ìur">S≈ìur</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">Pr√©nom *</label>
                                <input type="text" class="form-control form-control-sm" id="edit-iv-firstname" required>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1">Nom *</label>
                                <input type="text" class="form-control form-control-sm" id="edit-iv-lastname" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold mb-1">Cat√©gorie</label>
                                <select class="form-select form-select-sm" id="edit-iv-category">
                                    <option value="members">Membres</option>
                                    <option value="leaders">Dirigeants</option>
                                    <option value="deacons">Diacres</option>
                                    <option value="elders">Anciens</option>
                                    <option value="pastors">Pasteurs</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-warning btn-sm w-100" id="edit-intervenant-submit">
                                <i class="fas fa-save me-1"></i>Mettre √† jour
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `),document.getElementById("edit-intervenant-modal")}function de(){const t=z.calculateStats(o.interventions);t&&(document.getElementById("kpi-total").textContent=t.kpi.total,document.getElementById("kpi-speaker").textContent=t.kpi.topSpeaker,document.getElementById("kpi-place").textContent=t.kpi.topPlace,o.charts.timeline&&o.charts.timeline.destroy(),o.charts.types&&o.charts.types.destroy(),o.charts.speakers&&o.charts.speakers.destroy(),o.charts.timeline=new y(document.getElementById("chart-timeline"),{type:"line",data:{labels:t.charts.timeline.labels,datasets:[{label:"Interventions",data:t.charts.timeline.data,borderColor:"#0d6efd",tension:.4,fill:!0,backgroundColor:"rgba(13, 110, 253, 0.1)"}]},options:{responsive:!0,maintainAspectRatio:!1}}),o.charts.types=new y(document.getElementById("chart-types"),{type:"doughnut",data:{labels:t.charts.types.labels,datasets:[{data:t.charts.types.data,backgroundColor:["#0d6efd","#198754","#ffc107","#dc3545","#6c757d","#0dcaf0"]}]},options:{responsive:!0,plugins:{legend:{position:"bottom"}}}}),o.charts.speakers=new y(document.getElementById("chart-speakers"),{type:"bar",data:{labels:t.charts.speakers.labels,datasets:[{label:"Interventions",data:t.charts.speakers.data,backgroundColor:"#20c997",borderRadius:5}]},options:{responsive:!0,indexAxis:"y"}}))}function ce(){document.getElementById("main-form")?.addEventListener("submit",Be),document.getElementById("btn-reset")?.addEventListener("click",()=>{document.getElementById("main-form").reset(),D(""),b()}),document.getElementById("btn-suggest-intervenant")?.addEventListener("click",De),document.getElementById("form-create-intervenant")?.addEventListener("submit",ke),document.getElementById("refresh-btn")?.addEventListener("click",B),document.getElementById("btn-save-settings")?.addEventListener("click",be),document.getElementById("export-excel-btn")?.addEventListener("click",()=>{const t=$();t.length?x.exportToExcel(t,o.config):u.showAlert("Rien √† exporter","warning")}),document.getElementById("export-pdf-btn")?.addEventListener("click",()=>{const t=$();t.length?x.exportToPdf(t,o.config):u.showAlert("Rien √† exporter","warning")}),document.getElementById("search-input")?.addEventListener("input",t=>{o.searchQuery=t.target.value.toLowerCase(),Ae(),T()}),document.getElementById("visualization-type")?.addEventListener("change",k),document.getElementById("refresh-visualization")?.addEventListener("click",k),document.getElementById("apply-filters")?.addEventListener("click",k),document.getElementById("vis-search")?.addEventListener("input",t=>{}),document.getElementById("refresh-preview")?.addEventListener("click",N),document.getElementById("apply-preview-filters")?.addEventListener("click",N),document.getElementById("export-preview-pdf")?.addEventListener("click",ve),document.getElementById("export-preview-excel")?.addEventListener("click",ye),document.getElementById("preview-search")?.addEventListener("input",t=>{}),document.getElementById("theme-toggle")?.addEventListener("click",te),document.getElementById("btn-modify-intervenant")?.addEventListener("click",Ee),document.getElementById("btn-history-intervenant")?.addEventListener("click",we)}function k(){const t=document.getElementById("visualization-container"),e=document.getElementById("visualization-type")?.value||"timeline",n=document.getElementById("vis-start-date")?.value,r=document.getElementById("vis-end-date")?.value,a=document.getElementById("vis-search")?.value.toLowerCase();if(!t)return;let s=[...o.interventions];n&&(s=s.filter(i=>new Date(i.date)>=new Date(n))),r&&(s=s.filter(i=>new Date(i.date)<=new Date(r))),a&&(s=s.filter(i=>i.place.toLowerCase().includes(a)||i.type.toLowerCase().includes(a)||(i.intervenantStr||"").toLowerCase().includes(a))),t.innerHTML=`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2 text-muted">G√©n√©ration de la visualisation...</p>
        </div>
    `,setTimeout(()=>{switch(e){case"timeline":P(t,s);break;case"monthly":ue(t,s);break;case"by-type":me(t,s);break;case"by-place":fe(t,s);break;case"by-speaker":pe(t,s);break;default:P(t,s)}},100)}function P(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n=[...e].sort((a,s)=>new Date(a.date)-new Date(s.date));let r='<div class="timeline">';r+='<div class="row g-3">',n.forEach(a=>{const i=new Date(a.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"});r+=`
            <div class="col-md-6 col-lg-4">
                <div class="card border-start border-4 border-primary h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary">${a.type}</span>
                            <small class="text-muted">${i}</small>
                        </div>
                        <h6 class="card-title fw-bold">${a.intervenantStr||"Non assign√©"}</h6>
                        <p class="card-text small mb-1"><i class="fas fa-map-marker-alt me-1 text-muted"></i> ${a.place}</p>
                        ${a.description?`<p class="card-text small text-muted fst-italic">${a.description}</p>`:""}
                    </div>
                </div>
            </div>
        `}),r+="</div></div>",t.innerHTML=r}function ue(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n={};e.forEach(s=>{const i=new Date(s.date),l=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`;n[l]||(n[l]=[]),n[l].push(s)});const r=Object.keys(n).sort((s,i)=>new Date(i)-new Date(s));let a='<div class="monthly-visualization">';r.forEach(s=>{const l=new Date(s).toLocaleDateString("fr-FR",{month:"long",year:"numeric"}),d=n[s];a+=`
            <div class="card mb-3">
                <div class="card-header bg-light fw-bold">
                    <i class="fas fa-calendar me-2 text-primary"></i>${l} <span class="badge bg-primary ms-2">${d.length}</span>
                </div>
                <div class="card-body">
                    <div class="row g-2">
        `,d.forEach(c=>{const f=new Date(c.date).getDate();a+=`
                <div class="col-6 col-md-3 mb-2">
                    <div class="p-2 border rounded text-center">
                        <div class="fw-bold">${f}</div>
                        <small class="text-muted">${c.type}</small>
                    </div>
                </div>
            `}),a+=`
                    </div>
                </div>
            </div>
        `}),a+="</div>",t.innerHTML=a}function me(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n={};e.forEach(a=>{n[a.type]=(n[a.type]||0)+1});const r="chart-by-type";t.innerHTML=`<canvas id="${r}"></canvas>`,setTimeout(()=>{const a=document.getElementById(r);if(a&&Object.keys(n).length>0){o.charts&&o.charts.byType&&o.charts.byType.destroy();const s=a.getContext("2d"),i=new y(s,{type:"doughnut",data:{labels:Object.keys(n),datasets:[{data:Object.values(n),backgroundColor:["#0d6efd","#198754","#ffc107","#dc3545","#6c757d","#0dcaf0","#20c997","#6610f2"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}});o.charts||(o.charts={}),o.charts.byType=i}},100)}function fe(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n={};e.forEach(a=>{n[a.place]=(n[a.place]||0)+1});const r="chart-by-place";t.innerHTML=`<canvas id="${r}"></canvas>`,setTimeout(()=>{const a=document.getElementById(r);if(a&&Object.keys(n).length>0){o.charts&&o.charts.byPlace&&o.charts.byPlace.destroy();const s=a.getContext("2d"),i=new y(s,{type:"bar",data:{labels:Object.keys(n),datasets:[{label:"Nombre d'interventions",data:Object.values(n),backgroundColor:"#0d6efd",borderRadius:5}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}});o.charts||(o.charts={}),o.charts.byPlace=i}},100)}function pe(t,e){if(!e||e.length===0){t.innerHTML=`
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
            </div>
        `;return}const n={};e.forEach(s=>{const i=s.intervenantStr||"Non assign√©";n[i]=(n[i]||0)+1});const r=Object.entries(n).sort((s,i)=>i[1]-s[1]).slice(0,10),a="chart-by-speaker";t.innerHTML=`<canvas id="${a}"></canvas>`,setTimeout(()=>{const s=document.getElementById(a);if(s&&r.length>0){o.charts&&o.charts.bySpeaker&&o.charts.bySpeaker.destroy();const i=s.getContext("2d"),l=new y(i,{type:"bar",data:{labels:r.map(d=>d[0]),datasets:[{label:"Nombre d'interventions",data:r.map(d=>d[1]),backgroundColor:"#20c997",borderRadius:5}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}});o.charts||(o.charts={}),o.charts.bySpeaker=l}},100)}function N(){const t=document.getElementById("preview-container"),e=document.getElementById("preview-start-date")?.value,n=document.getElementById("preview-end-date")?.value,r=document.getElementById("preview-search")?.value.toLowerCase();if(!t)return;ge();let a=[...o.interventions];e&&(a=a.filter(s=>new Date(s.date)>=new Date(e))),n&&(a=a.filter(s=>new Date(s.date)<=new Date(n))),r&&(a=a.filter(s=>s.place.toLowerCase().includes(r)||s.type.toLowerCase().includes(r)||(s.intervenantStr||"").toLowerCase().includes(r))),t.innerHTML=`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2 text-muted">G√©n√©ration de l'aper√ßu...</p>
        </div>
    `,setTimeout(()=>{if(!a||a.length===0){t.innerHTML=`
                <div class="text-center py-5">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Aucune donn√©e √† afficher pour cette p√©riode</p>
                </div>
            `;return}const s=[...a].sort((l,d)=>new Date(l.date)-new Date(d.date));let i='<div class="preview-content">';i+=`
            <div class="text-center mb-4 pb-2 border-bottom">
                <img src="${o.config.logo}" id="preview-logo" alt="Logo" class="mb-2" style="max-height: 80px; max-width: 80px;">
                <h2 class="mb-1">${o.config.church}</h2>
                <p class="text-muted mb-0">${o.config.region} | ${o.config.section}</p>
                <p class="text-muted small mb-0">${o.config.phone?`T√©l√©phone: ${o.config.phone}`:""} ${o.config.email?`| Email: ${o.config.email}`:""}</p>
            </div>
        `,i+=`
            <div class="mb-4">
                <h4 class="text-center">Planning des Interventions</h4>
                <p class="text-center text-muted small">
                    ${e?`Du ${new Date(e).toLocaleDateString("fr-FR")}`:"Toutes les dates"}
                    ${n?`au ${new Date(n).toLocaleDateString("fr-FR")}`:""}
                </p>
            </div>
        `,i+=`
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Jour</th>
                            <th>Type</th>
                            <th>Lieu</th>
                            <th>Intervenant</th>
                            <th>Th√®me</th>
                        </tr>
                    </thead>
                    <tbody>
        `,s.forEach(l=>{const c=new Date(l.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"});i+=`
                <tr>
                    <td>${c}</td>
                    <td>${l.day}</td>
                    <td>${l.type}</td>
                    <td>${l.place}</td>
                    <td>${l.intervenantStr||"Non assign√©"}</td>
                    <td>${l.description||""}</td>
                </tr>
            `}),i+=`
                    </tbody>
                </table>
            </div>
        `,i+=`
            <div class="mt-5 pt-3 border-top text-center text-muted small">
                <p>Document g√©n√©r√© le ${new Date().toLocaleDateString("fr-FR")} √† ${new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}</p>
                <p>¬© ${new Date().getFullYear()} - ${o.config.church}</p>
            </div>
        `,i+="</div>",t.innerHTML=i},100)}function ge(){const t=document.getElementById("preview-logo"),e=document.getElementById("preview-church-name"),n=document.getElementById("preview-church-details");t&&(t.src=o.config.logo,t.alt=o.config.church),e&&(e.textContent=o.config.church),n&&(n.textContent=`R√©gion: ${o.config.region} | Section: ${o.config.section}`)}async function ve(){u.showAlert("Export PDF en cours...","info");const t=document.getElementById("preview-start-date")?.value,e=document.getElementById("preview-end-date")?.value,n=document.getElementById("preview-search")?.value.toLowerCase();let r=[...o.interventions];t&&(r=r.filter(a=>new Date(a.date)>=new Date(t))),e&&(r=r.filter(a=>new Date(a.date)<=new Date(e))),n&&(r=r.filter(a=>a.place.toLowerCase().includes(n)||a.type.toLowerCase().includes(n)||(a.intervenantStr||"").toLowerCase().includes(n)));try{await x.exportToPdf(r,o.config,t,e),u.showAlert("Export PDF termin√© avec succ√®s !","success")}catch(a){console.error("Erreur lors de l'export PDF:",a),u.showAlert("Erreur lors de l'export PDF","danger")}}async function ye(){u.showAlert("Export Excel en cours...","info");const t=document.getElementById("preview-start-date")?.value,e=document.getElementById("preview-end-date")?.value,n=document.getElementById("preview-search")?.value.toLowerCase();let r=[...o.interventions];t&&(r=r.filter(a=>new Date(a.date)>=new Date(t))),e&&(r=r.filter(a=>new Date(a.date)<=new Date(e))),n&&(r=r.filter(a=>a.place.toLowerCase().includes(n)||a.type.toLowerCase().includes(n)||(a.intervenantStr||"").toLowerCase().includes(n)));try{await x.exportToExcel(r,o.config,t,e),u.showAlert("Export Excel termin√© avec succ√®s !","success")}catch(a){console.error("Erreur lors de l'export Excel:",a),u.showAlert("Erreur lors de l'export Excel","danger")}}function he(){const t=document.getElementById("date");t&&(t.value||(t.value=o.currentDate,D(o.currentDate)),t.addEventListener("change",e=>{o.currentDate=e.target.value,D(e.target.value),b(document.getElementById("intervenant").value)}))}function D(t){const e=document.getElementById("day-display"),n=document.getElementById("day-text");if(!t){e.style.display="none";return}const r=new Date(t);isNaN(r)||(n.textContent=I.DAYS_OF_WEEK[r.getDay()],e.style.display="block")}async function B(){u.toggleLoading(!0);try{const[t,e,n]=await Promise.all([g.getIntervenants(),g.getInterventions(),g.getConfig("global_config")]);o.intervenants=t,o.interventions=e,n&&(o.config={...o.config,...n},["church","region","section","year","quarter","phone","email","bank","logo"].forEach(a=>{const s=document.getElementById(`config-${a}`);s&&(s.value=o.config[a]||"")})),b(document.getElementById("intervenant").value),T(),u.updateSyncStatus("synced")}catch(t){console.error(t),u.showAlert("Erreur chargement","danger")}finally{u.toggleLoading(!1)}}async function be(){o.config={church:document.getElementById("config-church").value,region:document.getElementById("config-region").value,section:document.getElementById("config-section").value,year:document.getElementById("config-year").value,quarter:document.getElementById("config-quarter").value,phone:document.getElementById("config-phone").value,email:document.getElementById("config-email").value,bank:document.getElementById("config-bank").value,logo:document.getElementById("config-logo").value},u.toggleLoading(!0);try{await g.saveConfig("global_config",o.config),u.showAlert("Configuration et En-t√™te enregistr√©s !","success")}catch(t){console.error(t),u.showAlert("Erreur lors de l'enregistrement","danger")}finally{u.toggleLoading(!1)}}function b(t=null){const e=document.getElementById("intervenant"),n=document.getElementById("date").value;if(!e)return;const r=t||e.value;e.innerHTML='<option value="">S√©lectionner...</option>',o.intervenants.sort((a,s)=>a.last_name.localeCompare(s.last_name)),o.intervenants.forEach(a=>{const s=document.createElement("option");s.value=a.id;const i=o.interventions.find(l=>l.date===n&&l.intervenantId===a.id);i?(s.textContent=`üö´ ${a.title?`${a.title} `:""}${a.last_name.toUpperCase()} ${a.first_name} (D√©j√† pris : ${i.type})`,s.disabled=!0,s.classList.add("text-danger")):s.textContent=`${a.title?`${a.title} `:""}${a.last_name.toUpperCase()} ${a.first_name}`,e.appendChild(s)}),r&&(e.value=r)}async function we(){const e=document.getElementById("intervenant").value;if(!e){u.showAlert("Veuillez d'abord s√©lectionner un intervenant","warning");return}await Ie(e)}async function Ee(){const e=document.getElementById("intervenant").value;if(!e){u.showAlert("Veuillez d'abord s√©lectionner un intervenant","warning");return}const n=o.intervenants.find(r=>r.id===e);if(!n){u.showAlert("Intervenant non trouv√©","danger");return}await oe(n)}async function Ie(t){try{const e=await g.getInterventionsByIntervenant(t),n=o.intervenants.find(r=>r.id===t);if(!n){u.showAlert("Intervenant non trouv√©","danger");return}await xe(n,e)}catch(e){console.error("Erreur lors de la r√©cup√©ration de l'historique:",e),u.showAlert("Erreur lors de la r√©cup√©ration de l'historique","danger")}}function xe(t,e){return new Promise(n=>{let r=document.getElementById("history-modal");r||(r=Se());const a=r.querySelector(".modal-title");a.innerHTML=`<i class="fas fa-history me-2"></i>Historique de ${t.title?`${t.title} `:""}${t.last_name.toUpperCase()} ${t.first_name}`;const s=r.querySelector(".modal-body");if(e.length===0)s.innerHTML='<div class="text-center py-4"><i class="fas fa-inbox fa-2x text-muted mb-3"></i><p class="text-muted">Aucune intervention enregistr√©e</p></div>';else{let l='<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Date</th><th>Type</th><th>Lieu</th><th>Th√®me</th></tr></thead><tbody>';e.forEach(d=>{const p=new Date(d.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"});l+=`<tr><td>${p}</td><td>${d.type}</td><td>${d.place}</td><td>${d.description||""}</td></tr>`}),l+="</tbody></table></div>",s.innerHTML=l}const i=new h(r);r.addEventListener("hidden.bs.modal",()=>{n(!1)},{once:!0}),i.show()})}function Se(){return document.body.insertAdjacentHTML("beforeend",`
        <div class="modal fade" id="history-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-info text-white py-2">
                        <h6 class="modal-title small fw-bold"></h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-3">
                        <!-- Historique sera charg√© ici -->
                    </div>
                    <div class="modal-footer bg-light py-2">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
    `),document.getElementById("history-modal")}function $(){return o.interventions.filter(t=>{if(!o.searchQuery)return!0;const e=o.searchQuery;return t.place.toLowerCase().includes(e)||t.type.toLowerCase().includes(e)||(t.intervenantStr||"").toLowerCase().includes(e)})}function T(){const t=document.getElementById("planning-container"),e=document.getElementById("count-badge");if(!t)return;const n=$();if(e.textContent=n.length,n.length===0){t.innerHTML='<div class="text-center text-muted py-5"><small>Aucune donn√©e</small></div>';return}t.innerHTML=n.map(r=>{const a=new Date(r.date);return`
        <div class="list-group-item border-0 border-bottom py-3">
            <div class="d-flex align-items-center">
                <div class="text-center me-3 border rounded px-2 py-1 bg-white shadow-sm" style="min-width: 60px;">
                    <div class="h5 mb-0 fw-bold text-dark">${a.getDate()}</div>
                    <div class="small text-uppercase text-muted" style="font-size: 0.65rem;">${a.toLocaleDateString("fr-FR",{month:"short"})}</div>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        <span class="badge bg-primary me-2" style="font-size: 0.7em;">${r.type}</span>
                        <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>${r.place}</small>
                        <small class="text-muted ms-2 border-start ps-2">${r.day}</small>
                    </div>
                    <h6 class="mb-0 fw-bold text-dark">${r.intervenantStr||r.intervenant?.last_name||"Non assign√©"}</h6>
                    ${r.description?`<div class="small text-muted mt-1 fst-italic text-truncate" style="max-width: 300px;">${r.description}</div>`:""}
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-link text-success opacity-75 hover-opacity-100 p-0" onclick="window.sendWhatsAppReminder('${r.id}')" title="Rappel WhatsApp">
                        <i class="fab fa-whatsapp fa-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-primary opacity-75 hover-opacity-100 p-0" onclick="window.editIntervention('${r.id}')" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-info opacity-75 hover-opacity-100 p-0" onclick="showComments('${r.id}')" title="Commentaires">
                        <i class="fas fa-comments"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-warning opacity-75 hover-opacity-100 p-0" onclick="showFeedback('${r.id}')" title="Feedback">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-danger opacity-50 hover-opacity-100 p-0" onclick="window.deleteIntervention('${r.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>`}).join("")}function Ae(){const t={search:o.searchQuery};localStorage.setItem("ad_planning_prefs",JSON.stringify(t))}function Le(){const t=localStorage.getItem("ad_planning_prefs");if(t)try{const e=JSON.parse(t);e.search&&(o.searchQuery=e.search,document.getElementById("search-input").value=e.search)}catch(e){console.error("Erreur chargement prefs",e)}}async function De(){const t=document.getElementById("date").value,e=document.getElementById("type").value;if(!t||!e){u.showAlert("Veuillez d'abord s√©lectionner une date et un type.","warning");return}const n=document.getElementById("modalSuggestions"),r=new h(n);r.show(),document.getElementById("suggestions-list").innerHTML='<div class="text-center py-4"><div class="spinner-border text-warning" role="status"></div><p class="mt-2 small text-muted">Analyse IA...</p></div>';try{const s=(await O.getSuggestions(t,e)).map(i=>{const l=i.score>80?"success":i.score>50?"warning":"secondary";return`<a href="#" class="list-group-item list-group-item-action p-3 suggestion-item" data-id="${i.id}"><div class="d-flex w-100 justify-content-between align-items-center"><div><h6 class="mb-1 fw-bold text-dark">${i.first_name} ${i.last_name} <small class="text-muted fw-normal">(${i.title||"Membre"})</small></h6><div class="small text-muted">${i.reasons.map(d=>`<span>‚Ä¢ ${d}</span>`).join(" ")}</div></div><div class="text-end"><span class="badge bg-${l} rounded-pill">${i.score}%</span></div></div></a>`}).join("");document.getElementById("suggestions-list").innerHTML=s||'<div class="p-3 text-center">Aucune suggestion.</div>',document.querySelectorAll(".suggestion-item").forEach(i=>{i.addEventListener("click",l=>{l.preventDefault();const d=i.dataset.id;document.getElementById("intervenant").value=d,r.hide(),document.getElementById("intervenant").classList.add("is-valid"),setTimeout(()=>document.getElementById("intervenant").classList.remove("is-valid"),2e3)})})}catch(a){console.error(a),document.getElementById("suggestions-list").innerHTML=`<div class="text-danger p-3">Erreur lors de l'analyse.</div>`}}async function Be(t){if(t.preventDefault(),!t.target.checkValidity()){t.stopPropagation(),t.target.classList.add("was-validated");return}u.toggleLoading(!0);try{const e=document.getElementById("date").value,n=document.getElementById("day-text").textContent,r=document.getElementById("place").value,a=document.getElementById("type").value,s=document.getElementById("theme").value,i=document.getElementById("obs").value,l=document.getElementById("intervenant").value,d=document.getElementById("intervenant").options[document.getElementById("intervenant").selectedIndex].text,c=document.getElementById("recurrence").value,p=document.getElementById("recurrence-end-date").value;let f=s;if(i&&(f+=(f?" | ":"")+i),o.editingId){const v={date:e,day:n!=="..."?n:I.DAYS_OF_WEEK[new Date(e).getDay()],place:r,type:a,description:f,intervenantId:l,intervenantStr:d,recurrence:c,recurrence_end_date:p};await g.updateIntervention(o.editingId,v),u.showAlert("Intervention mise √† jour !","success"),o.editingId=null;const w=document.querySelector('#main-form button[type="submit"]');w&&(w.innerHTML='<i class="fas fa-plus"></i> Ajouter',w.classList.remove("btn-warning"),w.classList.add("btn-primary")),A("Planification mise √† jour","success",!0)}else{const v={date:e,day:n!=="..."?n:I.DAYS_OF_WEEK[new Date(e).getDay()],place:r,type:a,description:f,intervenantId:l,intervenantStr:d,recurrence:c,recurrence_end_date:p};c!=="none"?await se(v):await g.addIntervention(v),u.showAlert("Enregistr√© !","success"),A("Nouvelle planification ajout√©e","success",!0)}t.target.reset(),t.target.classList.remove("was-validated"),D(o.currentDate),document.getElementById("date").value=o.currentDate,await B()}catch(e){u.showAlert("Erreur: "+e.message,"danger")}finally{u.toggleLoading(!1)}}async function ke(t){t.preventDefault();const e=t.target.querySelector('button[type="submit"]'),n=e.innerHTML;e.innerHTML='<i class="fas fa-spinner fa-spin"></i>',e.disabled=!0;try{const r={title:document.getElementById("modal-iv-title").value,first_name:document.getElementById("modal-iv-firstname").value,last_name:document.getElementById("modal-iv-lastname").value,category:"members"},a=await g.addIntervenant(r),s=document.getElementById("modalNewIntervenant");h.getInstance(s).hide(),o.intervenants.push(a),b(a.id),t.target.reset(),u.showAlert("Intervenant cr√©√© !","success")}catch(r){alert("Erreur: "+r.message)}finally{e.innerHTML=n,e.disabled=!1}}window.deleteIntervention=async t=>{if(confirm("Supprimer ?"))try{await g.deleteIntervention(t),await B(),A("Planification supprim√©e","danger",!0)}catch(e){console.error(e)}};window.sendWhatsAppReminder=t=>{const e=o.interventions.find(l=>l.id===t);if(!e)return;const n=new Date(e.date).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}),r=e.intervenantStr||(e.intervenant?`${e.intervenant.first_name} ${e.intervenant.last_name}`:"Bien-aim√©"),a=e.description?` sur le th√®me : "${e.description}"`:"",s=`Bonjour ${r}, c'est le secr√©tariat de l'√©glise AD BERACA. 

Rappel pour votre intervention (${e.type}) pr√©vue ce ${n} √† ${e.place}${a}. 

Soyez richement b√©ni !`,i=`https://wa.me/?text=${encodeURIComponent(s)}`;window.open(i,"_blank")};window.editIntervention=async t=>{const e=o.interventions.find(s=>s.id===t);if(!e){u.showAlert("Intervention non trouv√©e","danger");return}document.getElementById("date").value=e.date,document.getElementById("day-text").textContent=e.day,document.getElementById("place").value=e.place,document.getElementById("type").value=e.type;const n=e.description?e.description.split(" | "):[];if(n.length>0&&(document.getElementById("theme").value=n[0]||""),n.length>1?document.getElementById("obs").value=n.slice(1).join(" | "):document.getElementById("obs").value="",e.intervenant)document.getElementById("intervenant").value=e.intervenant.id;else{const s=o.intervenants.find(i=>i.last_name===e.intervenantStr?.split(" ")[0]&&i.first_name===e.intervenantStr?.split(" ")[1]);s?document.getElementById("intervenant").value=s.id:document.getElementById("intervenant").value=""}document.getElementById("main-form").scrollIntoView({behavior:"smooth"});const r=document.querySelector('#main-nav button[data-view="form-view"]');r&&r.click(),o.editingId=t;const a=document.querySelector('#main-form button[type="submit"]');a&&(a.innerHTML='<i class="fas fa-save"></i> Mettre √† jour',a.classList.add("btn-warning"),a.classList.remove("btn-primary"))};
